<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* [‡∏™‡πà‡∏ß‡∏ô CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏õ‡πä‡∏≠‡∏õ] */
        :root { --primary: #1a73e8; --bg: #f0f2f5; --sidebar-w: 260px; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px 0; transition: transform 0.3s; z-index: 1000; height: 100%; box-sizing: border-box; overflow-y: auto; }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 4px; }
        
        .app-brand { padding: 0 20px 20px; border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0; }
        .app-brand h2 { margin: 0; color: var(--primary); font-size: 1.1rem; line-height: 1.5; display: flex; align-items: center; gap: 10px; }
        
        .menu-item { padding: 12px 20px; cursor: pointer; color: #555; display: flex; align-items: center; gap: 12px; text-decoration: none; transition: 0.2s; font-weight: 500; flex-shrink: 0; }
        .menu-item:hover { background: #f5f9ff; color: var(--primary); }
        .menu-item.active { background: #e8f0fe; color: var(--primary); border-right: 3px solid var(--primary); }
        .menu-item i { width: 24px; text-align: center; }
        
        /* Sidebar Footer */
        .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid #eee; background: #fdfdfd; flex-shrink: 0; }
        .doc-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .doc-item:last-child { border-bottom: none; margin-bottom: 0; }
        .doc-name { font-size: 0.85rem; color: #555; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }
        .doc-running-row { display: flex; align-items: center; gap: 5px; font-size: 1.2rem; font-weight: bold; color: #333; padding-left: 24px; }
        .year-select-inline { font-size: 0.9rem; font-weight: bold; color: #1a73e8; border: 1px solid #dcebfd; background: #f5f9ff; border-radius: 4px; padding: 2px 5px; cursor: pointer; outline: none; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô */
        .btn-plus-run { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; margin-left: 5px; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-plus-run:hover { background: #1a73e8; color: white; transform: scale(1.1); }
        .btn-plus-run:active { transform: scale(0.9); }
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô (Input) */
        .run-input { width: 50px; text-align: right; border: none; background: transparent; font-size: 1.3rem; font-weight: bold; font-family: inherit; color: inherit; border-bottom: 1px dashed transparent; transition: 0.2s; padding: 0; }
        .run-input:hover, .run-input:focus { border-bottom: 1px dashed #aaa; outline: none; background: #fff; }
        .run-input::-webkit-outer-spin-button, .run-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Content Styles */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page-section { display: none; animation: fadeIn 0.3s; padding-bottom: 80px; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 2000; background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px; cursor: pointer; }
        
        /* Grid & Cards (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ú‡∏™‡∏° Grid ‡πÉ‡∏´‡∏°‡πà) */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .link-card { background: #fff; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-decoration: none; color: #333; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
        .link-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .link-card i { font-size: 2.5rem; margin-bottom: 5px; }
        .link-card h3 { margin: 0; font-size: 1.1rem; }
        .link-card p { margin: 0; font-size: 0.85rem; color: #888; }
        .ic-pm { color: #ea4335; } .ic-map { color: #34a853; } .ic-web { color: #1a73e8; } .ic-drive { color: #fbbc04; }
        .img-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .img-section img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #eee; }
        
        /* Board Styles */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; align-items: start; }
        .column { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; }
        .col-header { font-weight: bold; padding: 10px 15px; color: white; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        .btn-head-add { background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-head-add:hover { background: rgba(255,255,255,0.5); transform: scale(1.1); }
        .head-clinic { background: #29b6f6; } .head-pollution { background: #4caf50; } .head-prevent { background: #ec407a; color: white !important; } .head-prevent .btn-head-add { background: rgba(255,255,255,0.25); color:white; } .head-checkup { background: #1565c0; } .head-hospital { background: #ef5350; } .head-center { background: #ab47bc; } 
        
        .sub-section { padding: 10px; min-height: 100px; display:flex; flex-direction:column; flex-grow:1; }
        .section-kpi { background-color: #f8fbfd; border-top: 2px dashed #dcebfd; }
        .section-title { font-size: 0.85rem; font-weight: bold; color: #888; margin-bottom: 10px; text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; gap: 5px; cursor: pointer; user-select: none; }
        .section-title:hover { color: var(--primary); }
        .section-title i { transition: transform 0.3s; }
        .section-title.collapsed i { transform: rotate(-90deg); }
        
        /* Card Styles Updated (Compact Mode) */
        .card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 8px 10px; margin-bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s; position: relative; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: #ccc; }
        .card.done { background: #d4edda !important; border: 1px solid #c3e6cb; border-left: 5px solid #28a745 !important; color: #155724; opacity: 0.7; padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .card.done .task-title { text-decoration: line-through; color: #155724; font-weight: normal; margin: 0; }
        .card.done i.fa-check-circle { color: #28a745; font-size: 1.2rem; margin-right: 8px; }
        .card.done:hover { opacity: 1; transform: scale(1.02); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .task-title { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 2px; line-height: 1.2; }
        .task-meta { font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; min-height: auto; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .badge.urgent { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; } 
        .badge.ok { background: #e8f5e9; color: #2e7d32; } 
        .badge.daily { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        
        .progress-cont { background: #e9ecef; border-radius: 7px; height: 14px; width: 100%; overflow: hidden; margin: 4px 0; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 0.65rem; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.6); z-index: 2; line-height: 14px; }
        .bg-danger { background-color: #dc3545; } .bg-warning { background-color: #ffc107; } .bg-success { background-color: #28a745; }
        
        .num-control { display: flex; gap: 2px; align-items: center; margin-top: 2px; }
        .num-input { width: 50px; height: 24px; padding: 0 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; background: #f8f9fa; font-size: 0.9rem; }
        .num-total { font-size: 0.85rem; color: #999; white-space: nowrap; font-weight: normal; }
        
        .checklist-item { font-size: 0.8rem; padding: 0; cursor: pointer; display: flex; gap: 6px; align-items: center; }
        .checklist-item.checked span { text-decoration: line-through; color: #aaa; }
        .checklist-item i { font-size: 0.9rem; }
        
        .card-actions { border-top: 1px solid #eee; margin-top: 4px; padding-top: 4px; display: flex; justify-content: space-between; align-items: center;}
        .btn-icon { background: none; border: 1px solid transparent; cursor: pointer; color: #666; font-size: 0.75rem; padding: 1px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
        .btn-icon:hover { background: #eee; }
        .btn-finish { color: #34a853; } .btn-restart { color: #fbbc04; background:#fff8e1; } .btn-remove { color: #ea4335; background:#fce8e6; } .btn-upload { color: #1a73e8; } 
        .has-file { background-color: #e8f0fe; color: #1a73e8; border-color: #d2e3fc; } 
        .btn-mini { border: none; padding: 0; border-radius: 4px; cursor: pointer; font-weight: bold; height: 24px; width: 24px; line-height: 22px; font-size: 0.8rem; }
        
        .task-content-scroll { margin-bottom: 2px; }
        
        /* Badge NEW */
        .badge-new { background-color: #ff4757; color: #ffffff; font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 20px; margin-left: 8px; box-shadow: 0 2px 5px rgba(255, 71, 87, 0.4); display: inline-block; animation: pulse-red 1.5s infinite; vertical-align: middle; }
        @keyframes pulse-red { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(255, 71, 87, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }
        
        /* Contact Table */
        .contact-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .contact-table th, .contact-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        .contact-table th { background: #f8f9fa; color: #666; font-weight: bold; }
        .contact-row:hover { background: #f8fbfd; }
        .search-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 0; box-sizing: border-box; }
        .contact-actions { display: flex; gap: 8px; }
        .btn-contact { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-edit { background: #e8f0fe; color: #1a73e8; } .btn-delete { background: #fce8e6; color: #ea4335; }
        
        /* Modal General */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-act { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; background: #1a73e8; margin-top: 5px; }
        .checklist-input-group { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .checklist-display { border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #f8f9fa; max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .cl-item-row { background: #fff; border: 1px solid #eee; padding: 8px 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-cl-del { color: #ea4335; cursor: pointer; background: none; border: none; font-size: 0.9rem; }
        .btn-cl-del:hover { color: #c62828; transform: scale(1.2); }
        .cl-placeholder { text-align: center; color: #aaa; font-size: 0.85rem; padding: 10px; }
        
        .section-separator { display: flex; align-items: center; gap: 10px; margin: 30px 0 20px; }
        .section-separator h3 { margin: 0; color: #555; white-space: nowrap; }
        .section-separator hr { width: 100%; border: 0; border-top: 2px solid #e0e0e0; }
        .btn-refresh { background: #f1f3f4; border: 1px solid #dadce0; color: #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; white-space: nowrap; }
        .btn-refresh:hover { background: #e8eaed; color: #333; }
        
        .header-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 0; }
        .header-group h1 { margin: 0; }
        .shift-badge { background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; padding: 5px 15px; border-radius: 20px; font-size: 1.2rem; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .shift-badge:hover { background: #ffe0b2; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .project-col-header { background: #3f51b5; color: white; padding: 12px 15px; font-weight: bold; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;}
        .owner-badge { font-size: 0.75rem; background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 5px; font-weight: bold; border: 1px solid #bbdefb; margin-right:4px;}
        
        .calendar-modal-content { max-width: 900px; width: 95%; height: 85vh; padding: 0; overflow: hidden; display: flex; flex-direction: column; background: #fff; }
        .modal-close-bar { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .calendar-frame-container { flex: 1; width: 100%; background: #fff; position: relative; }
        .calendar-frame-container iframe { width: 100%; height: 100%; border: 0; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.show { left: 0; } .menu-toggle { display: block; } .board { grid-template-columns: 1fr; } .column { margin-bottom: 20px; } .main-content { padding-top: 60px; } .tool-bar { flex-direction: column; }
            .header-group { gap: 10px; } .shift-badge { width: 100%; justify-content: center; }
        }
        /* üö® Emergency Overlay Styles (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß: ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÑ‡∏î‡πâ + ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) */
        #emergencyOverlay {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #b71c1c; color: white; z-index: 10000;
            
            /* üëá ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å center ‡πÄ‡∏õ‡πá‡∏ô flex-start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center;
            
            text-align: center; font-family: 'Sarabun', sans-serif;
            animation: bgPulse 2s infinite;
            
            /* üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ */
            overflow-y: auto; 
            padding-top: 50px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            padding-bottom: 50px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á */
        }
        
        #emergencyOverlay h1 { font-size: 3rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        #emergencyOverlay p { font-size: 1.5rem; margin-top: 10px; max-width: 80%; line-height: 1.4; }
        #emergencyOverlay .icon-box { font-size: 5rem; margin-bottom: 20px; animation: iconShake 0.5s infinite; }

        /* üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πâ‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ú‡∏ô ICS ‡∏°‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ "‡∏ó‡∏±‡∏ö" ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏î‡∏á */
        #modalImage {
            z-index: 10001 !important; /* ‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10000 */
        }
        
        @keyframes bgPulse { 
            0% { background-color: #b71c1c; } 
            50% { background-color: #d32f2f; } 
            100% { background-color: #b71c1c; } 
        }
        @keyframes iconShake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body>
  
<div id="emergencyOverlay" style="padding-top: 10px !important; position: fixed; overflow-y: auto;"> 
        
        <button onclick="deactivateEmergency()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 4px 10px; border-radius: 20px; cursor: pointer; font-size: 0.75rem; backdrop-filter: blur(4px); transition: 0.2s; z-index: 10002;">
            <i class="fas fa-user-shield"></i> ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        </button>

        <div class="home-grid" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; width: 100%; max-width: 600px; margin: 0 auto 10px auto; padding-right: 80px; padding-left: 10px;">
            <div class="link-card" onclick="openModalImage('https://lh3.googleusercontent.com/d/17TEmrWpI_Hz7ZeX3SP-WgBgcm05OjubV')" style="padding: 8px 2px; cursor: pointer; flex: 0 0 85px; border-radius: 8px;">
                <i class="fas fa-sitemap" style="color:#ea4335; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ICS OCC</h3>
            </div>
            <div class="link-card" onclick="openModalImage('https://lh3.googleusercontent.com/d/1KjyLrS1mhgmFZkGyeODL1kaIwT4zd8y3')" style="padding: 8px 2px; cursor: pointer; flex: 0 0 85px; border-radius: 8px;">
                <i class="fas fa-hospital-symbol" style="color:#ea4335; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ICS ‡∏£‡∏û.</h3>
            </div>
            <a href="https://drive.google.com/file/d/1_LfhLtn9yV9Mknzf8_oMBbL98ANcu6oa/view?usp=sharing" target="_blank" class="link-card" style="padding: 8px 2px; text-decoration:none; flex: 0 0 85px; border-radius: 8px;">
                <i class="fas fa-fire-extinguisher" style="color:#ff5722; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢</h3>
            </a>
            <a href="https://drive.google.com/file/d/1T2yG9ycqc8pH8WI_JAPrC_TTwdmTETFk/view?usp=sharing" target="_blank" class="link-card" style="padding: 8px 2px; text-decoration:none; flex: 0 0 85px; border-radius: 8px;">
                <i class="fas fa-biohazard" style="color:#7b1fa2; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">‡πÅ‡∏ú‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3>
            </a>
            <a href="https://drive.google.com/drive/folders/1KIhhUi0RuNeYOUhqEnKVn4iNLrQDXFd_" target="_blank" class="link-card" style="padding: 8px 2px; text-decoration:none; flex: 0 0 85px; border-radius: 8px;">
                 <i class="fas fa-bullhorn" style="color:#0288d1; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">One page</h3> 
            </a>
            <a href="https://drive.google.com/drive/folders/1vK3AE4nN-FpIH12P83z_slzKj8Azp1Ep?usp=sharing" target="_blank" class="link-card" style="padding: 8px 2px; text-decoration:none; flex: 0 0 85px; border-radius: 8px;"> 
                <i class="fas fa-folder-open" style="color:#607d8b; font-size: 1.2rem; margin-bottom:4px;"></i>
                <h3 style="font-size: 0.65rem; margin: 0; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Ø</h3>
            </a>
        </div> 

        <div class="icon-box" style="font-size: 2.5rem; margin-bottom: 5px;">‚ö†Ô∏è</div>
        <h1 style="font-size:1.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px;">EMERGENCY ALERT</h1>
        <p id="emergencyMsg" style="font-size:1rem; margin-top:5px; max-width:90%; background:rgba(0,0,0,0.2); padding:5px 15px; border-radius:20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏û‡∏¢‡∏û‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        
        <div style="display: flex; flex-wrap: wrap; gap: 15px; width: 95%; max-width: 1100px; justify-content: center; align-items: flex-start; margin-top: 15px;">
            
            <div style="flex: 1; min-width: 300px; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0 0 10px 0; font-size: 1rem; color: #fff; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px;">
                    <i class="fas fa-tasks"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡πÄ‡∏´‡∏ï‡∏∏
                </h3>
                
                <div id="checklistContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
                
               <div style="margin-top: 5px;">
                    <div id="customTaskList"></div>

                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                        <input type="text" id="newCustomTask" placeholder="+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à..." style="flex:1; padding:6px; border-radius:4px; border:none; font-size:0.9rem; background:rgba(255,255,255,0.9); color:#333;">
                        <button onclick="addNewTask()" style="background:#ff8f00; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>
                
            </div>

            <div style="flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px;">
                
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <h3 style="margin:0; font-size:1rem; color:#fff;"><i class="fas fa-history"></i> ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</h3>
                        <button onclick="postLog()" style="background:#fff; color:#b71c1c; border:none; padding:4px 10px; border-radius:4px; font-size:0.8rem; cursor:pointer; font-weight:bold;">+ Post</button>
                    </div>
                    <div id="logContainer" style="height: 150px; overflow-y: auto;"></div>
                </div>

                <div style="background: rgba(46, 204, 113, 0.15); border-radius: 10px; padding: 10px; border: 1px solid rgba(46, 204, 113, 0.4);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0; font-size:1rem; color:#fff;">
            <i class="fas fa-user-check"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        </h3>
        <div style="font-size:0.75rem; display:flex; gap:5px;">
             <span style="background:#27ae60; color:white; padding:2px 6px; border-radius:4px;" title="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß">‚úÖ <span id="countReported">0</span></span>
             <span style="background:#c0392b; color:white; padding:2px 6px; border-radius:4px;" title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß">‚ùå <span id="countMissing">0</span></span>
        </div>
    </div>
    
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="selAttendName" style="flex:1; padding:6px; border-radius:4px; border:none; font-size:0.9rem; background:rgba(255,255,255,0.9); color:#333;">
            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>
        </select>
        
        <input type="password" id="attendPin" placeholder="PIN/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡πâ‡∏≤‡∏¢ 4" style="width:100px; padding:6px; border-radius:4px; border:none; font-size:0.9rem; text-align:center; background:rgba(255,255,255,0.9); color:#333;">
        
        <button onclick="submitMyAttendance()" id="btnAttendSubmit" style="background:#2ecc71; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">
            <i class="fas fa-check"></i>
        </button>
    </div>

    <div style="font-size:0.8rem; color:#ddd; margin-bottom:4px; border-bottom:1px solid rgba(255,255,255,0.2);">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß)</div>
    <div id="attendanceList" style="height: 100px; overflow-y: auto; text-align:left;">
        </div>
</div>
</div>
        </div>
        <br>
    </div>

    <div id="modalEmgUpload" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:11000; justify-content:center; align-items:center;">
        <div style="background:white; width:90%; max-width:400px; padding:20px; border-radius:10px; text-align:center;">
            <h3 style="margin-top:0; color:#333;">üìé ‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
            <p id="lblEmgUploadTopic" style="color:#666; font-size:0.9rem; margin-bottom:15px;">...</p>
            
            <input type="hidden" id="emgUploadIndex">
            <input type="file" id="emgFile" accept="image/*,application/pdf" style="margin-bottom:15px;">
            
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="document.getElementById('modalEmgUpload').style.display='none'" style="padding:8px 20px; border:none; background:#eee; cursor:pointer; border-radius:5px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="submitEmgUpload()" id="btnEmgUpload" style="padding:8px 20px; border:none; background:#1a73e8; color:white; cursor:pointer; border-radius:5px; font-weight:bold;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
            </div>
        </div>
    </div>

    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <div class="app-brand">
            <h2><i class="fas fa-briefcase-medical"></i> Occ-Health <br>
            <span style="font-size:0.9rem; color:#666;">Data Hub</span></h2>
            
            <div style="margin-top: 8px; font-size: 0.7rem; display: flex; gap: 6px; align-items: center;">
                
                <a href="https://docs.google.com/document/d/1VnLoBIdXwtisYJCaPGlOhycLdvzuOY6p6ZLQZO03joA/edit?usp=sharing" target="_blank" 
                   style="color: #0d47a1; text-decoration: none; display: flex; align-items: center; gap: 4px; background: #e3f2fd; padding: 3px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #bbdefb; transition: 0.2s;">
                    <i class="fas fa-book-reader"></i> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </a>

               <a href="#" onclick="openPrdSafely('https://docs.google.com/document/d/1Q5cC7xSz8RqaTrovTTQtkc1TVREYzm5f3wpeNfz7pE0/edit?usp=sharing')" 
                   style="color: #444; text-decoration: none; display: flex; align-items: center; gap: 4px; background: #f5f5f5; padding: 3px 8px; border-radius: 10px; font-weight: bold; border: 1px solid #ddd; transition: 0.2s;">
                    <i class="fas fa-user-lock"></i> Dev / PRD
                </a>

            </div>
            </div>
        
        <div style="margin-top: 20px; padding: 10px; background: #ffebee; border: 2px dashed #ffcdd2; border-radius: 8px; text-align: center;">
                <div style="font-weight: bold; color: #c62828; margin-bottom: 5px;">üö® ‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
                <button onclick="openEmerModal()" style="background: #c62828; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                <i class="fas fa-bullhorn"></i> ‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
                </button>
            </div>
        <div class="menu-item active" onclick="switchPage('home', this)"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>
        <div class="menu-item" onclick="switchPage('kpi', this)"><i class="fas fa-chart-line"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° KPI</div>
        <div class="menu-item" onclick="switchPage('projects', this)"><i class="fas fa-project-diagram"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="menu-item" onclick="switchPage('occ-info', this)"><i class="fas fa-book-medical"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°</div>
        <div class="menu-item" onclick="openCalendarModal()"><i class="fas fa-calendar-alt"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</div>
        <div class="menu-item" onclick="switchPage('phonebook', this)"><i class="fas fa-address-book"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
        <div class="menu-item" onclick="openPrintModal()" style="color:#e65100; background:#fff3e0; border-right:3px solid #ffb74d;"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="menu-item" onclick="window.open('https://hrh.moph.go.th/', '_blank')"><i class="fas fa-globe"></i> ‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</div>

        <div class="sidebar-footer">
            <h4 style="margin: 0 0 15px; font-size: 0.9rem; color: #555;">üóÇÔ∏è ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h4>
            
            <div class="doc-item">
                <div class="doc-name"><i class="fas fa-file-invoice-dollar" style="color:#e67c73;"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                <div class="doc-running-row">
                    <input type="number" id="val_quotation" class="run-input" style="color:#e67c73;" onchange="manualUpdateRunNum('quotation', this.value)">
                    <button class="btn-plus-run" onclick="incrementRunNum('quotation')"><i class="fas fa-plus"></i></button>
                    <span style="font-size:1rem; color:#aaa; margin-left:5px;">/</span>
                    <select class="year-select-inline"><option value="69" selected>69</option><option value="68">68</option><option value="70">70</option></select>
                </div>
            </div>

            <div class="doc-item">
                <div class="doc-name"><i class="fas fa-file-invoice" style="color:#33b679;"></i> ‡πÉ‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</div>
                <div class="doc-running-row">
                    <input type="number" id="val_billing" class="run-input" style="color:#33b679;" onchange="manualUpdateRunNum('billing', this.value)">
                    <button class="btn-plus-run" onclick="incrementRunNum('billing')"><i class="fas fa-plus"></i></button>
                    <span style="font-size:1rem; color:#aaa; margin-left:5px;">/</span>
                    <select class="year-select-inline"><option value="69" selected>69</option></select>
                </div>
            </div>

            <div class="doc-item">
                <div class="doc-name"><i class="fas fa-user-secret" style="color:#fbbc04;"></i> ‡πÄ‡∏Ñ‡∏™‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô</div>
                <div class="doc-running-row">
                    <input type="number" id="val_investigation" class="run-input" style="color:#fbbc04;" onchange="manualUpdateRunNum('investigation', this.value)">
                    <button class="btn-plus-run" onclick="incrementRunNum('investigation')"><i class="fas fa-plus"></i></button>
                    <span style="font-size:1rem; color:#aaa; margin-left:5px;">/</span>
                    <select class="year-select-inline"><option value="69" selected>69</option></select>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div id="page-home" class="page-section active">
            <div class="header-group" style="margin-bottom: 20px;">
                <h1 style="text-align:left; font-size: 1.5rem;">üè† ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°</h1>
                <div class="shift-badge" onclick="openCalendarModal()">
                    <i class="fas fa-calendar-day"></i> <span id="shiftText">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ : ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
            </div>
            <div id="loading" style="text-align:center; margin-top:20px; color:#888;"><i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div class="section-separator">
                <h3>üìä ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Routine)</h3>
                <div style="display:flex; gap:10px; align-items:center;"> 
                    <button class="btn-refresh" onclick="loadAllData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <hr>
            </div>
            <div class="board" id="boardRoutine" style="display:none;"></div>
            <div class="section-separator"><h3>üîó ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</h3><hr></div>
            <div class="home-grid">
                <a href="https://occhrh-dev.github.io/infopm2.5/" target="_blank" class="link-card"><i class="fas fa-smog ic-pm"></i><h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PM 2.5</h3><p>One page ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PM 2.5</p></a>
                <a href="https://occhrh-dev.github.io/pollution-map/" target="_blank" class="link-card"><i class="fas fa-map-marked-alt ic-map"></i><h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</h3><p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p></a>
                <a href="https://drive.google.com/drive/folders/1iX99F94VC0q0rn3_WHYxX0Wy04t-0XMD?usp=sharing" target="_blank" class="link-card"><i class="fa-face-smile-beam"></i><h3>logo ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</h3><p>logo ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</p></a>
            </div>
            <div class="section-separator"><h3>üö® ‡πÅ‡∏ú‡∏ô‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏£‡∏∞‡∏¢‡∏≠‡∏á</h3><hr></div>
            <div class="img-section"><img src="https://lh3.googleusercontent.com/d/1qFiZ3GOLXD2HTVKU4UUVBvbPIej1HE5P" alt="Emergency Plan"></div>
            <div class="section-separator"><h3>üö® ‡πÄ‡∏Å‡∏ì‡∏ë‡πå DCIRs</h3><hr></div>
            <div class="img-section"><img src="https://lh3.googleusercontent.com/d/1EMscfJgyM_IiHN5dsmKaP9QQUQyivTLJ" alt="DCIRs"></div>
        </div>

        <div id="page-occ-info" class="page-section">
            <h1 style="text-align:left; margin-top:0;">üìö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°</h1>
            
            <div class="section-separator"><h3>üö® ‡πÅ‡∏ú‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ</h3><hr></div>
            <div class="home-grid">
                <div class="link-card" onclick="openModalImage('https://lh3.googleusercontent.com/d/17TEmrWpI_Hz7ZeX3SP-WgBgcm05OjubV')">
                    <i class="fas fa-sitemap" style="color:#ea4335;"></i>
                    <h3>ICS OCC</h3>
                    <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ</p>
                </div>
                <div class="link-card" onclick="openModalImage('https://lh3.googleusercontent.com/d/1KjyLrS1mhgmFZkGyeODL1kaIwT4zd8y3')">
                    <i class="fas fa-hospital-symbol" style="color:#ea4335;"></i>
                    <h3>ICS ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h3>
                    <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ</p>
                </div>
                <a href="https://drive.google.com/file/d/1_LfhLtn9yV9Mknzf8_oMBbL98ANcu6oa/view?usp=sharing" target="_blank" class="link-card"> <i class="fas fa-fire-extinguisher" style="color:#ff5722;"></i>
                    <h3>‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢</h3>
                    <p>‡πÅ‡∏ú‡∏ô‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏≠‡∏û‡∏¢‡∏û‡∏´‡∏ô‡∏µ‡πÑ‡∏ü</p>
                </a>
                <a href="https://drive.google.com/file/d/1T2yG9ycqc8pH8WI_JAPrC_TTwdmTETFk/view?usp=sharing" target="_blank" class="link-card"> <i class="fas fa-biohazard" style="color:#7b1fa2;"></i>
                    <h3>‡πÅ‡∏ú‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏†‡∏±‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3>
                    <p>‡πÅ‡∏ú‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏†‡∏±‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</p>
                </a>
                <a href="https://drive.google.com/drive/folders/1KIhhUi0RuNeYOUhqEnKVn4iNLrQDXFd_" target="_blank" class="link-card"> <i class="fas fa-bullhorn" style="color:#0288d1;"></i>
                    <h3>One page ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</p>
                </a>
                <a href="https://drive.google.com/drive/folders/1vK3AE4nN-FpIH12P83z_slzKj8Azp1Ep?usp=sharing" target="_blank" class="link-card"> <i class="fas fa-folder-open" style="color:#607d8b;"></i>
                    <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h3>
                    <p>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏Ø</p>
                </a>
            </div>

            <div class="section-separator"><h3>üß™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3><hr></div>
            <div class="home-grid">
                <a href="https://drive.google.com/drive/folders/1loiYN3SJ8kv90ATF_Lg7EJHd9EiGVl5B?usp=sharing" target="_blank" class="link-card">
                    <i class="fas fa-flask" style="color:#34a853;"></i>
                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (SDS)</h3>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + Standing order</p>
                </a>
                <a href="https://drive.google.com/drive/folders/127fL0DajpUO3AP3j51sriWq8gaqDHL-W?usp=sharing" target="_blank" class="link-card">
                    <i class="fas fa-exclamation-triangle" style="color:#fbbc04;"></i>
                    <h3>HSDS</h3>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
                </a>
            </div>

            <div class="section-separator"><h3>üìù ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ</h3><hr></div>
            <div class="home-grid">
                <a href="https://drive.google.com/drive/folders/1HU5zHQZvKrV3NrhFcdjD9fUQ8ePc6eC3?usp=sharing" target="_blank" class="link-card"> <i class="fas fa-balance-scale" style="color:#1a73e8;"></i>
                    <h3>‡∏û‡∏£‡∏ö.‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</h3>
                    <p>‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°</p>
                </a>
                <a href="https://drive.google.com/drive/folders/1-4Oa2ZInS_ilcT11vttT0clqZrL0iAMv?usp=sharing" target="_blank" class="link-card">
                    <i class="fas fa-file-medical-alt" style="color:#1a73e8;"></i>
                    <h3>‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö</h3>
                    <p>‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</p>
                </a>
            </div>

            <div class="section-separator"><h3>üìÇ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3><hr></div>
            <div class="home-grid">
                <a href="https://drive.google.com/drive/folders/1ZcclJQDO-X1DPHqjMjxxXrPoBav_QYEU?usp=sharing" target="_blank" class="link-card"> <i class="fas fa-file-alt" style="color:#5f6368;"></i>
                    <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
                    <p>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
                </a>
                <a href="https://drive.google.com/drive/folders/1S8xGWf5mf_b1PKIZ0PbtFrCR3fAoZCdd" target="_blank" class="link-card"> 
                    <i class="fas fa-history" style="color:#1976d2;"></i>
                    <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                    <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive</p>
                </a>
            </div>
        </div>

        <div id="page-kpi" class="page-section">
            <h1 style="text-align:left; margin-top:0;">üìà KPI Tracking</h1>
            <div class="section-separator">
                <h3>üèÜ ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h3>
                <button class="btn-refresh" onclick="loadAllData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <hr>
            </div>
            <div class="column" style="max-height:none; overflow:visible;">
                <div class="project-col-header" style="background: #1a73e8;">
                    <span>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Sheet: KPI)</span>
                    <button class="btn-head-add" onclick="openAddTask(null, '‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î', 'kpi')"><i class="fas fa-plus"></i></button>
                </div>
                <div class="sub-section" id="list-kpi-active" style="padding:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
            </div>
        </div>

        <div id="page-projects" class="page-section">
            <h1 style="text-align:left; margin-top:0;">üìÇ Project Tracking System</h1>
            <div class="section-separator">
                <h3>üìä ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
                <button class="btn-refresh" onclick="loadAllData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <hr>
            </div>
            <div class="column" style="max-height:none; overflow:visible;">
                <div class="project-col-header">
                    <span>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Sheet: Projects)</span>
                    <button class="btn-head-add" onclick="openAddTask(null, 'General', 'project')"><i class="fas fa-plus"></i></button>
                </div>
                <div class="sub-section" id="list-projects-active" style="padding:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
            </div>
        </div>

        <div id="modalCalendar" class="modal">
            <div class="modal-content calendar-modal-content">
                <div class="modal-close-bar">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                        <button class="btn-act" style="width:auto; padding:5px 10px; margin:0; font-size:0.8rem; background:#34a853;" onclick="openAddEventModal()">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                        </button>
                    </div>
                    <button class="btn-icon" onclick="closeModal('modalCalendar')"><i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î</button>
                </div>
                <div class="calendar-frame-container">
                    <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Asia%2FBangkok&showPrint=0&src=b2NjLmhyaEBnbWFpbC5jb20&src=ZmFjZWI5MGFlNGY3MWUyNTNlNjYxMjJkY2Y1MzJiMjU0YzFmNDE2M2RiYzYzMGNjNWI4Yzc1ODAxYjc3ZjBhYkBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=OWY5MGI4NDgzMDMxNTZkNzdiM2FhYzI2MmQwN2IzZTMzYzhkYzg2YmI4ZGE2MzEzYTgwOWU3ZmU5ZWZlN2ZmNEBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=NWEwMTJhNzIwZDI2YmVmN2NlYTM5MTFkOTgwZmViNDQ0NDIyMTNkZjRjYTRkMmE5MTQ1NTAxNmNlNDVmZTg5ZkBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=NDkxM2UwZTFiNDQxZDEyMGE0Y2UzN2ZmMTQyNjc4ZmM3NGU1NjJjNzE4NjU4YTRmZGMyNTU2YmRlYjZmZmViOUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=NWNkM2Y1YjRjNGUyMmM2YzNlYTA1MTY4MmRlN2VkNTA2ZGFlYzMwMzAxN2EzYmNkZWJhNTY4OWU2ZjZkMTJjZUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=ZDI0MWIzM2YzNGU5Y2JkZTQxMDI2ZmE4ZTQ1MjhmYjhjMDQ1NDliMmY3MWQ4NDQwOTUzOWRjZGMxNDMyNThiZEBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&src=ODAwOTc4NTc0YzZiNGIxOGI1MjI4ZjI1MzE4NWVlYzgwOWE3ODdiYzM5ZTFjYTM3YWExMTRkZDJmY2Q1NmY0Y0Bncm91cC5jYWxlbmRhci5nb29nbGUuY29t&color=%238e24aa&color=%233f51b5&color=%23039be5&color=%23e67c73&color=%2333b679&color=%23d50000&color=%23e4c441&color=%23a79b8e" style="border:solid 1px #777" width="800" height="600" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>
        </div>

        <div id="page-phonebook" class="page-section"><h1 style="text-align:left; margin-top:0;">üìû ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1><div class="tool-bar" style="display:flex; gap:10px; margin-bottom:20px; align-items:center;"><input type="text" class="search-box" id="searchPhone" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." onkeyup="filterPhone()" style="flex:1; margin-bottom:0;"><button class="btn-act" onclick="openContactModal()" style="width:auto; margin:0; white-space:nowrap; background:#1a73e8;"><i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button></div><div id="phoneLoading" style="text-align:center; color:#888;"><i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div><table class="contact-table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th style="width:100px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="phoneList"></tbody></table></div>
    </div>

    <div id="modalImage" class="modal" onclick="closeModal('modalImage')">
        <div class="modal-content" style="width:auto; max-width:90%; background:transparent; box-shadow:none; padding:0;">
            <img id="imgPreview" src="" style="width:100%; border-radius:8px; border:2px solid #fff;">
        </div>
    </div>

    <div id="modalAdd" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;" id="taskModalTitle">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addTaskForm">
            <input type="hidden" id="tId"><input type="hidden" id="tMode">
            
            <div id="form-task-only">
                <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                <select id="tCat">
                    <option value="‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</option>
                    <option value="‡∏á‡∏≤‡∏ô‡∏°‡∏•‡∏û‡∏¥‡∏©">‡∏á‡∏≤‡∏ô‡∏°‡∏•‡∏û‡∏¥‡∏©</option>
                    <option value="‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô">‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</option>
                    <option value="‡∏á‡∏≤‡∏ô Check Up">‡∏á‡∏≤‡∏ô Check Up</option>
                    <option value="‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                    <option value="‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ø">‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ø</option>
                </select>

                <input type="hidden" id="tClass" value="‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥">
            </div>

                <div id="form-project-only" style="display:none; background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px;">
                    
                    <div id="divKpi" style="display:none; background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; border:1px dashed #aec4e5;">
                        <label style="color:#1967d2;">üìå ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                        <input type="text" id="tKpiSource" placeholder="‡πÄ‡∏ä‡πà‡∏ô HA-2025">
                    </div>

                    <label>üë• ‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                        <select id="tOwner" class="owner-select" style="width:100%;"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1 --</option></select>
                        <select id="tOwner2" class="owner-select" style="width:100%;"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) --</option></select>
                        <select id="tOwner3" class="owner-select" style="width:100%;"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 3 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) --</option></select>
                    </div>
                </div>

                <label id="lblTitle">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input type="text" id="tTitle" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." required>
                <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;"><input type="checkbox" id="chkDaily" onchange="togDate()" style="width: auto; margin: 0; cursor: pointer;"><span style="color: #333; cursor: pointer;" onclick="document.getElementById('chkDaily').click()">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span></div><input type="date" id="tDate">
                <div id="form-measure-type"><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•</label><select id="tType" onchange="togInp()"><option value="number">üìä ‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</option><option value="checklist">‚úÖ ‡πÅ‡∏ö‡∏ö Checklist</option></select></div>
                <input type="number" id="tTarNum" placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)"><div id="divChecklistControl" style="display:none;"><label id="lblChecklist">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label><div class="checklist-input-group"><input type="text" id="newClItem" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢" style="margin-bottom:0;" onkeypress="if(event.key==='Enter'){event.preventDefault(); addClItem();}"><button type="button" class="btn-act" style="width:auto; margin:0; background:#28a745; padding: 10px 15px;" onclick="addClItem()"><i class="fas fa-plus"></i></button></div><div id="clDisplay" class="checklist-display"><div class="cl-placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢</div></div></div>
                <div style="display:flex; gap:10px; margin-top:15px;"><button type="button" class="btn-act" style="background:#f0f0f0; color:#555;" onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button><button type="button" class="btn-act" style="background:#ddd; color:#333;" onclick="closeModal('modalAdd')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn-act" onclick="saveTask()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
            </form>
        </div>
    </div>

    <div id="modalAddEvent" class="modal">
        <div class="modal-content" style="max-width:350px;">
            <h3 style="margin-top:0;">üóìÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ / ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
            <label>‡∏•‡∏á‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</label>
            <select id="evtCalName">
                <option value="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏°‡∏•‡∏û‡∏¥‡∏©">‡∏á‡∏≤‡∏ô‡∏°‡∏•‡∏û‡∏¥‡∏©</option>
                <option value="‡∏á‡∏≤‡∏ô Check up">‡∏á‡∏≤‡∏ô Check up</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø ‡πÉ‡∏ô ‡∏£‡∏û.">‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø ‡πÉ‡∏ô ‡∏£‡∏û.</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô">‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ø">‡∏á‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ø</option>
                <option value="‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</option>
                <option value="‡∏≠‡∏ö‡∏£‡∏°/‡∏î‡∏π‡∏á‡∏≤‡∏ô/‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏ö‡∏£‡∏°/‡∏î‡∏π‡∏á‡∏≤‡∏ô/‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤, ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°)</label><input type="text" id="evtTitle" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="evtDate">
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)</label><textarea id="evtDesc" rows="3" style="width:100%; border:1px solid #ddd; border-radius:6px; padding:10px; box-sizing:border-box;" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô..."></textarea>
            <div style="display:flex; gap:10px; margin-top:15px;"><button type="button" class="btn-act" style="background:#ddd; color:#333;" onclick="closeModal('modalAddEvent')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn-act" onclick="submitEvent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>

    <div id="modalUpload" class="modal"><div class="modal-content"><h3 style="margin-top:0;">üìé ‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h3><p id="uploadTaskTitle" style="color:#666; font-size:0.9rem;"></p><input type="hidden" id="uploadTaskId"><input type="hidden" id="uploadItemIndex"><input type="hidden" id="uploadMode"><input type="file" id="uFile" accept="image/*,.pdf"><div style="display:flex; gap:10px; margin-top:15px;"><button type="button" class="btn-act" style="background:#ddd; color:#333;" onclick="closeModal('modalUpload')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn-act" onclick="submitUpload()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button></div></div></div>
    
    <div id="modalContact" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;" id="contactModalTitle">üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
        <input type="hidden" id="cId">
        
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="cName">
        
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="cPhone">

        <div id="boxChangePin" style="display:none; margin-top:10px; padding:10px; background:#f1f8e9; border:1px dashed #8bc34a; border-radius:6px;">
            <label style="color:#2e7d32; font-weight:bold;">üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</label>
            <input type="password" id="cNewPin" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà (‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)" style="margin-bottom:0;">
            <small style="color:#666;">*‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ</small>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button type="button" class="btn-act" style="background:#ddd; color:#333;" onclick="closeModal('modalContact')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="button" class="btn-act" onclick="saveContact()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

    <div id="modalPrintOptions" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <h3 style="margin-top:0;"><i class="fas fa-print"></i> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            
            <label style="font-weight:bold; margin-bottom:5px; display:block;">1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;">
                    <label style="font-size:0.85rem;">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="printStartDate" class="form-control">
                </div>
                <div style="flex:1;">
                    <label style="font-size:0.85rem;">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="printEndDate" class="form-control">
                </div>
            </div>

            <hr style="border-top:1px solid #eee; margin:15px 0;">

            <label style="font-weight:bold; margin-bottom:10px; display:block;">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á:</label>
            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                
                <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chkRoutine" checked style="width:18px; height:18px; margin:0; cursor:pointer;"> 
                    <span style="font-size:1rem;">üìã ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Routine)</span>
                </label>
                
                <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chkProject" checked style="width:18px; height:18px; margin:0; cursor:pointer;"> 
                    <span style="font-size:1rem;">üöÄ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Projects)</span>
                </label>
                
                <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chkKPI" checked style="width:18px; height:18px; margin:0; cursor:pointer;"> 
                    <span style="font-size:1rem;">üéØ ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (KPIs)</span>
                </label>

            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button type="button" class="btn-act" style="background:#ddd; color:#333;" onclick="closeModal('modalPrintOptions')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn-act" onclick="generateReport()">
                    <i class="fas fa-print"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Doc Running)
        // ----------------------------------------------------
        function loadInitialDocNumbers() {
            var types = ['quotation', 'billing', 'investigation'];
            types.forEach(function(type) {
                google.script.run.withSuccessHandler(function(num) {
                    var el = document.getElementById('val_' + type);
                    if(el) el.value = num;
                }).getDocRunningNumber(type);
            });
        }
        function incrementRunNum(type) {
            google.script.run.withSuccessHandler(function(newNum) {
                document.getElementById('val_' + type).value = newNum;
            }).incrementDocRunningNumber(type);
        }
        function manualUpdateRunNum(type, newVal) {
            if(!newVal) return;
            google.script.run.withSuccessHandler(function(res) {
                console.log('Updated: ' + res);
            }).setDocRunningNumber(type, newVal);
        }

        // ----------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        // ----------------------------------------------------

        function openModalImage(src) { document.getElementById('imgPreview').src = src; document.getElementById('modalImage').style.display = 'flex'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
        function switchPage(pageId, el) { 
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active')); 
            if(pageId !== 'schedule') { 
                document.getElementById('page-'+pageId).classList.add('active');
                if(el) { document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active')); el.classList.add('active'); } 
                if(window.innerWidth < 768) toggleSidebar();
            } 
        }
        function openCalendarModal() { document.getElementById('modalCalendar').style.display = 'flex'; }
        function openAddEventModal() { document.getElementById('modalAddEvent').style.display = 'flex'; document.getElementById('evtTitle').value = ''; document.getElementById('evtDate').valueAsDate = new Date(); document.getElementById('evtDesc').value = ''; }
        function submitEvent() { var calName = document.getElementById('evtCalName').value; var title = document.getElementById('evtTitle').value; var date = document.getElementById('evtDate').value; var desc = document.getElementById('evtDesc').value; if(!title || !date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); var btn = event.target; btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true; google.script.run.withSuccessHandler(function(res) { alert(res === "Success" ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res); closeModal('modalAddEvent'); var frame = document.querySelector('.calendar-frame-container iframe'); if(frame) frame.src = frame.src; btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.disabled = false; }).addEventToCalendar({calName: calName, title: title, date: date, desc: desc}); }
        
        let currentChecklistItems = []; let tasks = []; let projects = []; let kpis = []; let contacts = [];
        const CAT_MAP = { '‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å': 'head-clinic', '‡∏á‡∏≤‡∏ô‡∏°‡∏•‡∏û‡∏¥‡∏©': 'head-pollution', '‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô': 'head-prevent', '‡∏á‡∏≤‡∏ô Check Up': 'head-checkup', '‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏Ø‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': 'head-hospital', '‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ø': 'head-center' };
        
        window.onload = function() { 
    loadAllData(); 
    loadTodayShifts(); 
    loadInitialDocNumbers(); 
    document.getElementById('lblMonth').innerText = new Date().toLocaleDateString('th-TH', { month: 'long' }); 
};
        
        function loadTodayShifts() { google.script.run.withSuccessHandler(function(names) { document.getElementById('shiftText').innerText = "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ : " + names; }).getTodayShifts(); }
        
        function loadAllData() { 
            checkEmergencyStatus(); // <--- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            document.getElementById('loading').style.display = 'block'; 
            document.getElementById('phoneLoading').style.display = 'block';

            google.script.run.withSuccessHandler(res => { 
                let data = JSON.parse(res); 
                tasks = data.tasks; 
                projects = data.projects; 
                kpis = data.kpis; 
                contacts = data.contacts; 
                
                updateOwnerDropdowns(); 
                renderBoard('boardRoutine', tasks, 'task', 'routine_only'); 
                
                // Render Grid ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KPI ‡πÅ‡∏•‡∏∞ Projects
                renderGrid('list-kpi-active', kpis, 'kpi');
                renderGrid('list-projects-active', projects, 'project'); 
                
                document.getElementById('loading').style.display = 'none'; 
                document.getElementById('boardRoutine').style.display = 'grid'; 
                
                renderContacts(contacts); 
                document.getElementById('phoneLoading').style.display = 'none';

                // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÅ‡∏õ‡∏∞ ‚úÖ‚úÖ‚úÖ
                loadTodayBadges();

            }).getAllData();
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Dropdown ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á
        function updateOwnerDropdowns() {
            const selects = ['tOwner', 'tOwner2', 'tOwner3'];
            selects.forEach(id => {
                let sel = document.getElementById(id);
                if(sel) {
                    let currentVal = sel.value;
                    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà --</option>`;
                    contacts.forEach(c => {
                        sel.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                    });
                    sel.value = currentVal;
                }
            });
        }

        function renderGrid(containerId, dataList, mode) {
            let container = document.getElementById(containerId);
            container.innerHTML = '';
            if(!dataList || dataList.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; grid-column:1/-1;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            dataList.forEach(item => {
                container.innerHTML += createCard(item, mode);
            });
        }

        function renderBoard(containerId, dataList, mode, filterType) { 
            let container = document.getElementById(containerId);
            container.innerHTML = ''; 
            for(let cat in CAT_MAP) { 
                let headClass = CAT_MAP[cat]; let colId = `col-${Object.keys(CAT_MAP).indexOf(cat)}-${mode}`;
                let routineHtml = `<div class="sub-section section-routine" style="border-top:none;"><div class="section-title"><span>üìã ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span></div><div id="${colId}-routine"></div></div>`;
                container.innerHTML += `<div class="column"><div class="col-header ${headClass}"><span>${cat}</span><button class="btn-head-add" onclick="openAddTask(null, '${cat}', '${mode}', '${filterType}')"><i class="fas fa-plus"></i></button></div>${routineHtml}</div>`;
            } 
            dataList.forEach(t => { 
                if(!CAT_MAP[t.category]) return; 
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô KPI ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥
                if(t.task_class === '‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î') return;
                let colIdx = Object.keys(CAT_MAP).indexOf(t.category); 
                document.getElementById(`col-${colIdx}-${mode}-routine`).innerHTML += createCard(t, mode); 
            });
        }
function createCard(t, mode) { 
            let isDone = t.status === 'Done';
            
            // 1. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô (Owner)
            let ownerHtml = '';
            if((mode === 'project' || mode === 'kpi') && t.task_class) {
                let owners = t.task_class.split(', ');
                let badges = owners.map(o => `<span class="owner-badge">${o}</span>`).join('');
                ownerHtml = `<div class="owner-group" style="margin-bottom:4px;">${badges}</div>`;
            }

            // ‚úÖ‚úÖ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚úÖ‚úÖ‚úÖ
            let sourceHtml = '';
            if (t.kpi_source && t.kpi_source.trim() !== '') {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°)
                sourceHtml = `<div style="font-size:0.75rem; color:#c2185b; background:#fce4ec; display:inline-block; padding:2px 8px; border-radius:4px; margin-bottom:5px; font-weight:bold; border:1px solid #f8bbd0;">
                    <i class="fas fa-tag"></i> ${t.kpi_source}
                </div><br>`;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Done)
            if(isDone) return `<div class="card done">${ownerHtml}<div>${sourceHtml}<span class="task-title" style="text-decoration:line-through; color:#155724;"><i class="fas fa-check-circle"></i> ${t.title}</span></div><div class="card-actions"><div class="right-actions"><button class="btn-icon" onclick="openAddTask('${t.id}', null, '${mode}')"><i class="fas fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-icon btn-restart" onclick="archiveTask('${t.id}', 'reset', '${mode}')" title="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà"><i class="fas fa-redo"></i></button><button class="btn-icon btn-remove" onclick="archiveTask('${t.id}', 'archive', '${mode}')" title="‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å"><i class="fas fa-trash-alt"></i></button></div></div></div>`;
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Badge ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            let badgeCls = '', dayTxt = ''; 
            if (t.is_daily) { badgeCls = 'daily'; dayTxt = 'üîÅ ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô'; } 
            else { 
                if(!t.deadline) {
                    badgeCls = 'ok'; dayTxt = 'Ongoing';
                } else {
                    let diff = Math.ceil((new Date(t.deadline) - new Date().setHours(0,0,0,0))/86400000);
                    badgeCls = diff < 0 ? 'urgent' : (diff<=3 ? 'urgent' : 'ok'); 
                    dayTxt = diff < 0 ? `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(diff)} ‡∏ß‡∏±‡∏ô` : (diff==0 ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô`);
                }
            } 
            
            // Badge NEW
            let newBadgeHtml = '';
            if (t.timestamp) {
                let taskDate = new Date(t.timestamp);
                let today = new Date();
                if (taskDate.toDateString() === today.toDateString()) { newBadgeHtml = '<span class="badge-new"><i class="fas fa-star"></i> NEW</span>'; }
            }

            let progressBar = ''; 
            let bodyHtml = '';
            let uploadBtn = '';

            // ==========================================
            // LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Number / Checklist)
            // ==========================================
            if(t.type == 'number') { 
                let cur = parseInt(t.progress)||0;
                let hasTarget = (t.target && t.target != '0'); 
                
                if (!hasTarget) {
                    // --- üìå ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î ---
                    let nextMilestone = 100;
                    if (cur >= 100) nextMilestone = 500;
                    if (cur >= 500) nextMilestone = 1000;
                    if (cur >= 1000) nextMilestone = Math.ceil((cur + 1) / 1000) * 1000;

                    let pct = Math.min(100, Math.round((cur / nextMilestone) * 100));

                    let totalDisplay = `
                        <div style="display:flex; align-items:baseline; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size:0.9rem; color:#666;">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°:</span>
                            <span style="font-size:1.4rem; font-weight:bold; color:#1a73e8;">${cur.toLocaleString()}</span>
                        </div>`;
                    
                    progressBar = `
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-bottom:2px;">
                            <span>Level Up</span><span>‡πÄ‡∏õ‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${nextMilestone.toLocaleString()}</span>
                        </div>
                        <div class="progress-cont" style="height:8px; margin-bottom:10px;">
                            <div class="progress-bar bg-info" style="width:${pct}%; background-color:#00bcd4;"></div>
                        </div>`;
                    
                    let logHtml = (t.LastLog && t.LastLog !== '' && t.LastLog !== '0') ? `<span style="font-size:0.8rem; color:#28a745; margin-left:5px;">(‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${t.LastLog})</span>` : '';
                    
                    bodyHtml = `
                        ${totalDisplay}
                        ${progressBar}
                        <div style="background:#f1f3f4; padding:8px; border-radius:6px; display:flex; gap:5px; align-items:center;">
                            <input type="number" id="add_input_${t.id}" class="num-input" placeholder="‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î" style="flex:1; width:auto; text-align:center;">
                            <button class="btn-mini" style="background:#1a73e8; color:white; width:auto; padding:0 10px; font-weight:normal;" onclick="addToTotal('${t.id}', ${cur}, '${mode}')">
                                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                        <div style="text-align:right; margin-top:2px;">${logHtml}</div>
                    `;

                } else {
                    // --- üìå ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢) ---
                    let tar = parseInt(t.target);
                    let pct = Math.min(100, Math.round((cur/tar)*100));
                    let logHtml = (t.LastLog && t.LastLog !== '' && t.LastLog !== '0') ? `<span style="font-size:0.8rem; font-weight:bold; color:${String(t.LastLog).includes('+')?'#2e7d32':'#c62828'}; margin-left:6px; background:#f1f8e9; padding:1px 5px; border-radius:4px;">${t.LastLog}</span>` : '';
                    
                    bodyHtml = `<div class="num-control"><button class="btn-mini" style="background:#ffebee;color:#c62828" onclick="updNum('${t.id}', -1, ${cur}, '${mode}')"><i class="fas fa-minus"></i></button><input type="number" class="num-input" value="${cur}" onchange="manualUpd('${t.id}', this.value, '${mode}')"><span class="num-total">/ ${tar}</span> ${logHtml} <button class="btn-mini" style="background:#e8f5e9;color:#2e7d32" onclick="updNum('${t.id}', 1, ${cur}, '${mode}')"><i class="fas fa-plus"></i></button></div>`;
                    
                    let barColor = pct > 75 ? 'bg-success' : (pct > 40 ? 'bg-warning' : 'bg-danger'); 
                    progressBar = `<div class="progress-cont"><div class="progress-bar ${barColor}" style="width:${pct}%"></div><div class="progress-text">${pct}%</div></div>`;
                }

                uploadBtn = t.evidence ? `<div style="display:inline-flex;align-items:center;gap:3px;"><a href="${t.evidence}" target="_blank" class="btn-icon has-file"><i class="fas fa-file-alt"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</a><button class="btn-icon btn-remove" style="padding:1px 6px;" onclick="deleteAttachment('${t.id}', -1, '${mode}')" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå"><i class="fas fa-times"></i></button></div>` : `<button class="btn-icon btn-upload" onclick="openUpload('${t.id}', '${t.title}', -1, '${mode}')"><i class="fas fa-paperclip"></i> ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</button>`;

            } else { 
                // --- üìå ‡πÇ‡∏´‡∏°‡∏î Checklist ---
                let items = [];
                try { items = t.progress.startsWith('[') ? JSON.parse(t.progress) : String(t.target).split(',').map((n,i)=>({item:n, status:String(t.progress).split(',')[i]=='true', file:''})); } catch(e){} 
                let pct = items.length>0 ? Math.round((items.filter(x=>x.status).length/items.length)*100) : 0; 
                items.forEach((obj, i) => { 
                    let fileBtn = obj.file ? `<div style="display:flex;align-items:center;"><a href="${obj.file}" target="_blank" style="color:#1a73e8;margin-left:5px;"><i class="fas fa-file-alt"></i></a><i class="fas fa-times" style="color:#ea4335;cursor:pointer;margin-left:5px;font-size:0.8rem;" onclick="deleteAttachment('${t.id}', ${i}, '${mode}')" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå"></i></div>` : `<i class="fas fa-paperclip" style="color:#ccc;cursor:pointer;margin-left:5px;font-size:0.8rem;" onclick="openUpload('${t.id}', '${obj.item}', ${i}, '${mode}')"></i>`; 
                    bodyHtml += `<div class="checklist-item ${obj.status?'checked':''}" style="justify-content:space-between;"><div style="display:flex;align-items:center;gap:6px;flex:1;" onclick="togCheck('${t.id}', ${i}, '${mode}')"><i class="fas ${obj.status?'fa-check-square':'fa-square'}" style="color:${obj.status?'#34a853':'#ccc'}"></i><span>${obj.item}</span></div><div>${fileBtn}</div></div>`;
                });
                let barColor = pct > 75 ? 'bg-success' : (pct > 40 ? 'bg-warning' : 'bg-danger'); 
                progressBar = `<div class="progress-cont"><div class="progress-bar ${barColor}" style="width:${pct}%"></div><div class="progress-text">${pct}%</div></div>`;
            } 
            
            let contentHtml = `<div class="task-content-scroll">${bodyHtml}</div>`;
            let finalProgress = (t.type == 'number' && (!t.target || t.target=='0')) ? '' : progressBar;

            // ‚úÖ ‡πÅ‡∏ó‡∏£‡∏Å sourceHtml ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏ï‡∏£‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ Task)
            return `<div class="card">
                ${ownerHtml}
                ${sourceHtml} 
                <div class="task-title">${t.title} ${newBadgeHtml}</div>
                <div class="task-meta"><span class="badge ${badgeCls}">${dayTxt}</span></div>
                ${finalProgress}
                ${contentHtml}
                <div class="card-actions"><div class="left-actions">${uploadBtn}</div><div class="right-actions"><button class="btn-icon" onclick="openAddTask('${t.id}', null, '${mode}')"><i class="fas fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-icon btn-finish" onclick="toggleFinish('${t.id}', '${mode}')"><i class="fas fa-check-circle"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à</button></div></div>
            </div>`;
        }
        function addToTotal(id, currentTotal, mode) {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á input ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
            let inputId = 'add_input_' + id;
            let valToAdd = parseInt(document.getElementById(inputId).value);

            if (isNaN(valToAdd) || valToAdd <= 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°");
                return;
            }

            let newTotal = parseInt(currentTotal) + valToAdd;
            
            // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ß‡πà‡∏≤ (+XX)
            sendUpd(id, {progress: newTotal}, mode);

            // ‚úÖ‚úÖ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚úÖ‚úÖ‚úÖ
            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÑ‡∏ß‡πâ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏£‡∏≠‡πÉ‡∏´‡πâ Backend ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
            setTimeout(function() {
                loadTodayBadges(); 
            }, 1000);
        }
function openAddTask(id, cat, mode, filterType) { 
            document.getElementById('modalAdd').style.display='flex';
            resetForm(); 
            document.getElementById('tMode').value = mode || 'task'; 
            document.getElementById('taskModalTitle').innerText = (mode==='project' || mode==='kpi' ? 'üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç '+mode : 'üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà');
            document.getElementById('lblTitle').innerText = (mode==='project'?'‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£':(mode==='kpi'?'‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î':'‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô'));
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
            if(mode === 'project' || mode === 'kpi') { 
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥
                document.getElementById('form-task-only').style.display='none';
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° Project/KPI
                document.getElementById('form-project-only').style.display='block'; 
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ KPI
                document.getElementById('divKpi').style.display = (mode === 'kpi') ? 'block' : 'none';

                // ============ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ============
                if (mode === 'kpi') {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô KPI: ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•" (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/Checklist)
                    document.getElementById('form-measure-type').style.display = 'block';
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô checklist (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô number ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                    if(!id) document.getElementById('tType').value = 'checklist'; 
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Project: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô Checklist ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                    document.getElementById('form-measure-type').style.display = 'none';
                    document.getElementById('tType').value = 'checklist';
                }
                // ===================================

                document.getElementById('lblChecklist').innerText='‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô';
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                document.getElementById('tClass').value = (mode === 'kpi') ? '‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î' : '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';

                updateOwnerDropdowns();
                togInp(); // ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏î‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            } else { 
                // ‡πÇ‡∏´‡∏°‡∏î‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Task)
                document.getElementById('form-task-only').style.display='block';
                document.getElementById('form-project-only').style.display='none'; 
                document.getElementById('divKpi').style.display='none'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                
                document.getElementById('form-measure-type').style.display='block'; 
                document.getElementById('lblChecklist').innerText='‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢'; 
                
                document.getElementById('tClass').value = '‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥';
                
                togKpi(); 
            } 
            // -----------------------------------
            
            if(id) { 
                let list;
                if(mode==='project') list = projects;
                else if(mode==='kpi') list = kpis;
                else list = tasks;

                let t = list.find(x=>String(x.id)===String(id));
                if(t) { 
                    document.getElementById('tId').value = t.id;
                    if(document.getElementById('tCat')) document.getElementById('tCat').value = t.category; 
                    document.getElementById('tKpiSource').value = t.kpi_source;
                    document.getElementById('tTitle').value = t.title; 
                    document.getElementById('chkDaily').checked = t.is_daily;

                    if(mode==='project' || mode==='kpi') {
                         let owners = t.task_class ? t.task_class.split(', ') : [];
                         document.getElementById('tOwner').value = owners[0] || "";
                         document.getElementById('tOwner2').value = owners[1] || "";
                         document.getElementById('tOwner3').value = owners[2] || "";
                    }

                    if (!t.is_daily && t.deadline) {
                        let d = new Date(t.deadline);
                        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                        document.getElementById('tDate').value = d.toISOString().split('T')[0];
                    }

                    document.getElementById('tType').value = t.type;
                    if(t.type == 'number') document.getElementById('tTarNum').value = t.target; 
                    else { currentChecklistItems = t.target.split(','); renderClItems(); } 
                    
                    togKpi();
                    togInp(); togDate();
                } 
            } else { 
                document.getElementById('tId').value = '';
                if(cat && document.getElementById('tCat')) document.getElementById('tCat').value = cat;
                if(mode==='project' || mode==='kpi'){ currentChecklistItems=[]; renderClItems(); } 
            } 
        }

        function saveTask() { 
            let mode = document.getElementById('tMode').value;
            let id = document.getElementById('tId').value; 
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ 3 Owners
            let o1 = document.getElementById('tOwner').value;
            let o2 = document.getElementById('tOwner2').value;
            let o3 = document.getElementById('tOwner3').value;
            let combinedOwners = [o1, o2, o3].filter(n => n !== "").join(", ");
            
            let owner = (mode==='project' || mode==='kpi') ? combinedOwners : document.getElementById('tClass').value; 
            let selectedCat = (mode === 'project') ? '‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' : (mode === 'kpi' ? 'KPI' : document.getElementById('tCat').value); 
            
            let payload = { action: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : 'add', mode: mode, id: id, category: selectedCat, task_class: owner, kpi_source:document.getElementById('tKpiSource').value, title:document.getElementById('tTitle').value, is_daily:document.getElementById('chkDaily').checked, deadline:document.getElementById('tDate').value, type:document.getElementById('tType').value }; 
            if(payload.type=='number') payload.target=document.getElementById('tTarNum').value;
            else { if(currentChecklistItems.length===0) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠'); payload.target=currentChecklistItems.join(','); } 
            
            if(!payload.title || !payload.target) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'); 
            const btn=event.target; btn.innerText='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled=true;
            google.script.run.withSuccessHandler(()=>{ closeModal('modalAdd'); loadAllData(); btn.innerText='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.disabled=false; }).saveItemToSheet(payload); 
        }

        function updNum(id, chg, cur, mode) { let val=parseInt(cur)+parseInt(chg); if(val<0)return; sendUpd(id, {progress:val}, mode); }
        function manualUpd(id, val, mode) { let v=parseInt(val); if(isNaN(v)||v<0)return; sendUpd(id, {progress:v}, mode); }
        function togCheck(id, idx, mode) { 
            let list;
            if(mode==='project') list = projects;
            else if(mode==='kpi') list = kpis;
            else list = tasks;

            let t = list.find(x=>x.id==id); let items = t.progress.startsWith('[') ? JSON.parse(t.progress) : []; items[idx].status = !items[idx].status;
            sendUpd(id, {progress:JSON.stringify(items)}, mode); 
        }
        function toggleFinish(id, mode) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô?')) sendUpd(id, {status:'Done'}, mode); }
        function archiveTask(id, type, mode) { if(type==='archive' && !confirm('‡∏•‡∏ö?')) return; if(type==='reset' && !confirm('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà?')) return; let payload = {status: type==='archive'?'Archived':'Active'}; 
            if(type==='reset') { 
                let list;
                if(mode==='project') list = projects;
                else if(mode==='kpi') list = kpis;
                else list = tasks;

                let t = list.find(x=>x.id==id); payload.reset=true; payload.new_progress = t.type=='number'?0:t.target.split(',').map(x=>'false').join(','); if(t.type=='checklist') { let items = t.target.split(','); payload.new_progress = JSON.stringify(items.map(x=>({item:x.trim(), status:false, file:''}))); } } sendUpd(id, payload, mode); 
        }
        function sendUpd(id, data, mode) { data.action = 'update_progress'; data.id = id; data.mode = mode; google.script.run.saveItemToSheet(data); setTimeout(loadAllData, 500); }
        function openUpload(id, title, index, mode) { document.getElementById('modalUpload').style.display='flex'; document.getElementById('uploadTaskId').value = id; document.getElementById('uploadItemIndex').value = index; document.getElementById('uploadMode').value = mode; document.getElementById('uploadTaskTitle').innerText = title; }
        function submitUpload() { let mode = document.getElementById('uploadMode').value; let id = document.getElementById('uploadTaskId').value; let idx = document.getElementById('uploadItemIndex').value; let f = document.getElementById('uFile').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô'); const btn=event.target; btn.innerText='‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'; btn.disabled=true; let r=new FileReader(); r.onload=function(e) { let action = (idx != -1) ? 'upload_checklist_item' : 'update_progress'; google.script.run.withSuccessHandler(()=>{ alert('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); closeModal('modalUpload'); loadAllData(); btn.innerText='‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; btn.disabled=false; }).saveItemToSheet({ action:action, id:id, mode:mode, itemIndex:idx, fileData:e.target.result, fileName:f.name, isChecklistItem:(idx!=-1) }); }; r.readAsDataURL(f); }
        function deleteAttachment(id, index, mode) { if(!confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; document.body.style.cursor = 'wait'; google.script.run.withSuccessHandler(function() { document.body.style.cursor = 'default'; loadAllData(); }).saveItemToSheet({ action: 'delete_file', id: id, mode: mode, itemIndex: index }); }
        
        function toggleSec(id, el) { let c=document.getElementById(id); c.style.display=c.style.display==='none'?'block':'none'; el.classList.toggle('collapsed'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function resetForm() { document.getElementById('addTaskForm').reset(); document.getElementById('tDate').valueAsDate = new Date(); currentChecklistItems = []; renderClItems(); togKpi(); togInp(); togDate(); }
        function togInp() { let t=document.getElementById('tType').value; document.getElementById('tTarNum').style.display=t=='number'?'block':'none'; document.getElementById('divChecklistControl').style.display=t=='checklist'?'block':'none'; }
        function togKpi() { document.getElementById('divKpi').style.display=document.getElementById('tClass').value=='‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î'?'block':'none'; }
        function togDate() { document.getElementById('tDate').disabled=document.getElementById('chkDaily').checked; }
        function addClItem() { let v=document.getElementById('newClItem').value.trim(); if(v) { currentChecklistItems.push(v); document.getElementById('newClItem').value=''; renderClItems(); } }
        function removeClItem(i) { currentChecklistItems.splice(i,1); renderClItems(); }
        function renderClItems() { document.getElementById('clDisplay').innerHTML = currentChecklistItems.length? currentChecklistItems.map((x,i)=>`<div class="cl-item-row"><span>${i+1}. ${x}</span><button type="button" class="btn-cl-del" onclick="removeClItem(${i})"><i class="fas fa-trash"></i></button></div>`).join('') : '<div class="cl-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; }
        
        function renderContacts(l) { document.getElementById('phoneList').innerHTML = l.map(c=>`<tr class="contact-row"><td>${c.name}</td><td><a href="tel:${c.phone}" style="color:#1a73e8;font-weight:bold;">${c.phone}</a></td><td class="contact-actions"><button class="btn-contact btn-edit" onclick="openContactModal('${c.id}')"><i class="fas fa-pen"></i></button><button class="btn-contact btn-delete" onclick="deleteContact('${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
        function filterPhone() { let t=document.getElementById('searchPhone').value.toLowerCase(); renderContacts(contacts.filter(c=>c.name.toLowerCase().includes(t)||c.phone.includes(t))); }
        // 1. ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á Script)
function openContactModal(id) { 
    document.getElementById('modalContact').style.display='flex';
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
    document.getElementById('cNewPin').value = ''; 

    if(id){
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
        let c = contacts.find(x => x.id == id);
        document.getElementById('cId').value = c.id;
        document.getElementById('cName').value = c.name;
        document.getElementById('cPhone').value = c.phone;
        document.getElementById('contactModalTitle').innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™';
        
        // üî• ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™
        document.getElementById('boxChangePin').style.display = 'block'; 
    } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ---
        document.getElementById('cId').value = '';
        document.getElementById('cName').value = '';
        document.getElementById('cPhone').value = '';
        document.getElementById('contactModalTitle').innerText = 'üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà';
        
        // üî• ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)
        document.getElementById('boxChangePin').style.display = 'none';
    } 
}

// 2. ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
function saveContact() { 
    let id = document.getElementById('cId').value;
    let n = document.getElementById('cName').value;
    let p = document.getElementById('cPhone').value; 
    // üî• ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà
    let newPin = document.getElementById('cNewPin').value;

    if(!n || !p) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

    let pass = "";
    if (!id) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -> ‡∏ñ‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™ Admin
        pass = prompt("‚õîÔ∏è (Admin Only) ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠:");
        if (!pass) return;
    } else {
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -> ‡∏ñ‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏° (PIN ‡∏´‡∏£‡∏∑‡∏≠ Admin)
        pass = prompt("üîê ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô: ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™ Admin):");
        if (!pass) return;
    }

    google.script.run.withSuccessHandler((res)=>{
        if(res == "WrongPass") {
             alert(id ? "‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ" : "‚ùå ‡∏£‡∏´‡∏±‡∏™ Admin ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        } else {
             closeModal('modalContact');
             loadAllData();
             alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
    }).saveContactToSheet({
        action: id ? 'edit_contact' : 'add_contact',
        id: id,
        name: n,
        phone: p,
        authPass: pass,     // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡πà‡∏≤/Admin)
        newUserPin: newPin  // üî• ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á
    }); 
}
       function deleteContact(id) { 
    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    
    // ‡∏ñ‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™ Admin
    let pass = prompt("‚õîÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:");
    if (!pass) return;

    google.script.run.withSuccessHandler((res)=>{
        if(res == "WrongPass") alert("‚ùå ‡∏£‡∏´‡∏±‡∏™ Admin ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        else { loadAllData(); alert("üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); }
    }).saveContactToSheet({action:'delete_contact', id:id, authPass: pass});
}
        // ----------------------------------------------------
      // ==========================================
        // üñ®Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (V.3 ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô + ‡∏à‡∏±‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà)
        // ==========================================
        
        function openPrintModal() {
            document.getElementById('modalPrintOptions').style.display = 'flex';
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ñ‡∏∂‡∏á ‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            let date = new Date();
            let firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            
            // Helper function ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date"
            const toInputDate = (d) => d.toISOString().split('T')[0];
            
            document.getElementById('printStartDate').value = toInputDate(firstDay);
            document.getElementById('printEndDate').value = toInputDate(date);
        }
// ==========================================
        // üñ®Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (V.Full Option: ‡πÅ‡∏Å‡πâ NaN + Checklist + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô)
        // ==========================================

        function generateReport() {
            let sDateVal = document.getElementById('printStartDate').value;
            let eDateVal = document.getElementById('printEndDate').value;
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Checkbox ‡∏ß‡πà‡∏≤ user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
            let opt = {
                routine: document.getElementById('chkRoutine').checked,
                project: document.getElementById('chkProject').checked,
                kpi: document.getElementById('chkKPI').checked
            };

            if (!opt.routine && !opt.project && !opt.kpi) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡πà‡∏ß‡∏ô");
                return;
            }

            let btn = event.target;
            let originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...';
            btn.disabled = true;

            const formatThDate = (dStr) => {
                if(!dStr) return "...";
                let d = new Date(dStr);
                return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            };
            let dateRangeText = `‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThDate(sDateVal)} ‡∏ñ‡∏∂‡∏á ${formatThDate(eDateVal)}`;

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend
            google.script.run.withSuccessHandler(function(reportData) {
                renderPrintWindow(reportData, kpis, projects, dateRangeText, opt);
                closeModal('modalPrintOptions');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).getReportByDateRange(sDateVal, eDateVal);
        }
function renderPrintWindow(taskList, kpiList, projectList, dateRangeLabel, options) {
    let printDate = new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
    let fontStack = "'Sarabun', sans-serif";
    
    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (11pt ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏¢)
    let tdStyle = 'border: 1px solid #000 !important; padding: 4px 6px; font-size: 11pt; line-height: 1.3; vertical-align: top;';
    let ownerStyle = 'border: 1px solid #000 !important; padding: 4px 6px; font-size: 10pt; line-height: 1.2; vertical-align: middle;';
    let thStyle = 'border: 1px solid #000 !important; padding: 6px; font-size: 11pt; font-weight: bold; background-color: #f0f0f0 !important; text-align: center; vertical-align: middle; -webkit-print-color-adjust: exact;';

    // ---------------------------------------------------------
    // 1. ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Routine)
    // ---------------------------------------------------------
    let routineHtml = '';
    if (options.routine) {
        let routineRows = taskList.filter(t => t.type == 'number' || t.type == 'checklist').map((t, index) => {
            let resultDisplay = '-', targetDisplay = '-', accumDisplay = '-';
            let pendingDisplay = '-'; // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà

            if (t.type === 'checklist') {
                let items = []; try { items = JSON.parse(t.progress); } catch(e) { items = []; }
                let totalItems = items.length;
                let completedItems = items.filter(i => i.status).length;
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
                let pendingItems = items.filter(i => !i.status).map(i => "‚Ä¢ " + i.item);
                
                resultDisplay = totalItems > 0 ? completedItems + " ‡∏Ç‡πâ‡∏≠" : "0";
                targetDisplay = totalItems > 0 ? totalItems + " ‡∏Ç‡πâ‡∏≠" : "-";
                accumDisplay = "-";
                
                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                if (pendingItems.length > 0) {
                    pendingDisplay = `<div style="text-align:left; font-size:10pt; color:#c62828;">${pendingItems.join('<br>')}</div>`;
                } else if (totalItems > 0) {
                    pendingDisplay = `<span style="color:#2e7d32; font-weight:bold;">‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>`;
                }

            } else {
                let rangeTotal = parseInt(t.range_total); if (isNaN(rangeTotal)) rangeTotal = 0;
                let accumTotal = parseInt(t.progress); if (isNaN(accumTotal)) accumTotal = 0;
                let target = parseInt(t.target);
                
                resultDisplay = rangeTotal.toLocaleString();
                accumDisplay = accumTotal.toLocaleString();
                targetDisplay = (!isNaN(target) && t.target !== "") ? target.toLocaleString() : "-";
                // ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå)
            }

            return `<tr>
                <td style="${tdStyle} text-align:center;">${index + 1}</td>
                <td style="${tdStyle} text-align:left;">${t.title}</td>
                <td style="${tdStyle} text-align:center;">${t.category}</td>
                <td style="${tdStyle} text-align:center; font-weight:bold;">${resultDisplay}</td>
                <td style="${tdStyle} text-align:center;">${targetDisplay}</td>
                <td style="${tdStyle} text-align:center;">${pendingDisplay}</td> <td style="${tdStyle} text-align:center; background-color:#fafafa;">${accumDisplay}</td>
            </tr>`;
        }).join('');

        routineHtml = `
            <h4 style="font-size:14pt; margin: 15px 0 5px 0; font-weight:bold; text-align:left;">1. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô (Routine)</h4>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr>
                        <th style="${thStyle} width:5%;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th style="${thStyle} width:25%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th style="${thStyle} width:12%;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                        <th style="${thStyle} width:10%;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
                        <th style="${thStyle} width:10%;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                        <th style="${thStyle} width:28%;">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</th> <th style="${thStyle} width:10%;">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°</th>
                    </tr>
                </thead>
                <tbody>${routineRows || '<tr><td colspan="7" style="text-align:center; border:1px solid #000; padding:10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'}</tbody>
            </table>`;
    }

    // ---------------------------------------------------------
    // 2. ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Project & KPI)
    // ---------------------------------------------------------
    let projectHtml = '';
    let combinedList = [];
    if (options.project) combinedList = combinedList.concat(projectList);
    if (options.kpi) combinedList = combinedList.concat(kpiList);

    if (combinedList.length > 0) {
        let projectRows = combinedList.map((p, index) => {
            
            let isKPI = (p.category === 'KPI' || p.category === '‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î');
            let typeLabel = isKPI ? 
                '<span style="color:#c2185b; font-weight:bold;">[KPI]</span>' : 
                '<span style="color:#1976d2; font-weight:bold;">[Pro]</span>';

            let resultDisplay = '-', targetDisplay = '-';
            let pendingDisplay = '-'; // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà

            if (p.type === 'checklist') {
                let items = []; try { items = JSON.parse(p.progress); } catch(e) { items = []; }
                let totalItems = items.length;
                let completedItems = items.filter(i => i.status).length;
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥
                let pendingItems = items.filter(i => !i.status).map(i => "‚Ä¢ " + i.item);

                targetDisplay = totalItems > 0 ? totalItems + " ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô" : "-";
                let pct = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                resultDisplay = `${completedItems} ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (${pct}%)`;

                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
                if (pendingItems.length > 0) {
                    pendingDisplay = `<div style="text-align:left; font-size:10pt; color:#c62828;">${pendingItems.join('<br>')}</div>`;
                } else if (totalItems > 0) {
                    pendingDisplay = `<span style="color:#2e7d32; font-weight:bold;">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>`;
                }

            } else {
                let cur = parseInt(p.progress) || 0;
                let target = parseInt(p.target);
                
                resultDisplay = cur.toLocaleString();
                targetDisplay = (!isNaN(target) && p.target !== "") ? target.toLocaleString() : "-";
            }

            let ownerName = p.task_class || "-";
            let assessName = p.kpi_source || "-";

            return `<tr>
                <td style="${tdStyle} text-align:center;">${index + 1}</td>
                <td style="${tdStyle} text-align:left;">${typeLabel} ${p.title}</td>
                <td style="${ownerStyle} text-align:center;">${ownerName}</td>
                <td style="${tdStyle} text-align:center;">${resultDisplay}</td>
                <td style="${tdStyle} text-align:center;">${targetDisplay}</td>
                <td style="${tdStyle} text-align:center;">${pendingDisplay}</td> <td style="${tdStyle} text-align:center;">${assessName}</td>
            </tr>`;
        }).join('');

        projectHtml = `
            <h4 style="font-size:14pt; margin: 15px 0 5px 0; font-weight:bold; text-align:left;">2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Project & KPI)</h4>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr>
                        <th style="${thStyle} width:5%;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th style="${thStyle} width:30%;">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</th>
                        <th style="${thStyle} width:12%;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                        <th style="${thStyle} width:12%;">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
                        <th style="${thStyle} width:8%;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                        <th style="${thStyle} width:23%;">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</th> <th style="${thStyle} width:10%;">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                    </tr>
                </thead>
                <tbody>${projectRows}</tbody>
            </table>`;
    }

    // ---------------------------------------------------------
    // 3. Generate HTML
    // ---------------------------------------------------------
    let printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</title>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: ${fontStack}; background: #525659; margin: 0; padding: 20px; }
                
                /* ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡πá‡∏ô ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Landscape) */
                .paper { 
                    background: white; 
                    padding: 2cm; 
                    width: 297mm;  /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
                    min-height: 210mm; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
                    margin: 0 auto; 
                    box-sizing: border-box; 
                    position: relative; 
                }
                
                @media print {
                    body * { visibility: hidden; }
                    .paper, .paper * { visibility: visible; }
                    .paper { position: absolute; left: 0; top: 0; margin: 0; padding: 1.5cm; width: 100%; box-shadow: none; }
                    
                    /* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Printer ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Landscape */
                    @page { size: A4 landscape; margin: 0; }
                }
                
                .toolbar { position: fixed; top: 0; left: 0; width: 100%; background: #323639; color: white; padding: 10px; text-align: center; display: flex; justify-content: center; gap: 10px; z-index: 9999; font-family: 'Sarabun', sans-serif; }
                .btn-print { background: #1a73e8; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; font-family: 'Sarabun'; }
                .btn-close { background: #ea4335; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; font-family: 'Sarabun'; }
                
                .header-container { width: 100%; text-align: center; margin-bottom: 20px; }
                h1 { font-size: 18pt; font-weight: bold; margin: 0 0 5px 0; line-height: 1.2; }
                h3 { font-size: 16pt; font-weight: bold; margin: 0; line-height: 1.2; }
                .date-info { font-size: 14pt; margin-top: 5px; color:#000; font-weight: bold; }
                
                .footer { margin-top: 50px; display: flex; justify-content: space-between; text-align: center; font-size: 14pt; }
            </style>
        </head>
        <body>
            <div class="toolbar">
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Print)</button>
                <button class="btn-close" onclick="window.close()">‚ùå ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
            <div class="paper">
                <div class="header-container">
                    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
                    <h3>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏Ø ‡∏£‡∏∞‡∏¢‡∏≠‡∏á</h3>
                    <div class="date-info">${dateRangeLabel}</div>
                    <div style="font-size:11pt; color:#666; margin-top:5px; font-weight:normal;">(‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${printDate})</div>
                </div>

                ${routineHtml}
                ${projectHtml}

                <div class="footer">
                    <div style="width:300px;"><br><br>......................................................<br>(......................................................)<br>‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div style="width:300px;"><br><br>......................................................<br>(......................................................)<br>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°</div>
                </div>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
}
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏∞‡∏õ‡πâ‡∏≤‡∏¢ "‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"
        function loadTodayBadges() {
            google.script.run.withSuccessHandler(function(stats) {
                for (var id in stats) {
                    var count = stats[id];
                    if (count > 0) {
                        var inputEl = document.getElementById('add_input_' + id);
                        if (inputEl) {
                            var labelId = 'today_badge_' + id;
                            if (!document.getElementById(labelId)) {
                                var badge = document.createElement("div");
                                badge.id = labelId;
                                badge.innerHTML = '<i class="fas fa-calendar-day"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span style="color:#2ecc71; font-weight:bold;">+' + count + '</span>';
                                badge.style.fontSize = "0.8rem";
                                badge.style.color = "#555";
                                badge.style.marginTop = "5px";
                                badge.style.textAlign = "right"; 
                                inputEl.parentNode.parentNode.insertBefore(badge, inputEl.parentNode);
                            } else {
                                document.getElementById(labelId).innerHTML = '<i class="fas fa-calendar-day"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span style="color:#2ecc71; font-weight:bold;">+' + count + '</span>';
                            }
                        }
                    }
                }
            }).getTodayLogStats();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin
        function openPrdSafely(url) {
            var input = prompt("üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:");
            if (input) {
                google.script.run.withSuccessHandler(function(isValid) {
                    if (isValid) {
                        window.open(url, '_blank');
                    } else {
                        alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á");
                    }
                }).checkAdminPass(input);
            }
        }

        // ==========================================
        // üö® ‡∏£‡∏∞‡∏ö‡∏ö Emergency (V.Sub-Menu SOP)
        // ==========================================

        // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Checklist (‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏° SOP)
        const EMERGENCY_STEPS = [
            { name: "1. ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£", subs: [] },
            { name: "2. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô (Activate RESCUE-C)", subs: [] },
            { name: "3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå EOC / ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£", subs: [] },
            { name: "4. ‡∏£‡∏∞‡∏î‡∏°‡∏û‡∏• (ICS) / ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß", subs: [
                "4.1 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (STAG/SAT)",
                "4.2 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Operation)",
                "4.3 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Logistics)",
                "4.4 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Finance)",
                "4.5 ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ (PR/Liaison)"
            ]},
            { name: "5. ‡∏ó‡∏µ‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Medical/SRRT)", subs: [] },
            { name: "6. ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ (‡∏¢‡∏≤/‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏£‡∏ñ)", subs: [] },
            { name: "7. ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á / ‡πÅ‡∏ñ‡∏•‡∏á‡∏Ç‡πà‡∏≤‡∏ß", subs: [] },
            { name: "8. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ / ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏¢‡∏∏‡∏ï‡∏¥", subs: [] },
            { name: "9. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô / ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏à‡∏ô‡∏ó.", subs: [] }
        ];

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Update V.Roll Call)
        function checkEmergencyStatus() {
            google.script.run.withSuccessHandler(function(state) {
                if (state.isActive) {
                    showEmergencyScreen(state.message);
                    renderChecklist(state.checklist); 
                    renderCustomTasks(state.customTasks); // ‚úÖ ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                    renderLogs(state.logs);
                    renderAttendance(state.attendance);
                    
                    if(document.getElementById('selAttendName').options.length <= 1) {
                        populateAttendanceDropdown();
                    }
                } else {
                    document.getElementById('emergencyOverlay').style.display = 'none';
                }
            }).getEmergencyState();
        }
// ==========================================
        // üôã‚Äç‚ôÇÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß (Smart Filter & Auto-Remove)
        // ==========================================

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• + ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown
        function renderAttendance(reportedList) {
            var listContainer = document.getElementById('attendanceList');
            
            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô) ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            if(!listContainer) return;

            // --- A. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏Ç‡∏≤‡∏î) ---
            var totalStaff = contacts ? contacts.length : 0;
            var reportedCount = reportedList.length;
            var missingCount = totalStaff - reportedCount;

            // ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡πÉ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            var elReported = document.getElementById('countReported');
            var elMissing = document.getElementById('countMissing');
            if(elReported) elReported.innerText = reportedCount;
            if(elMissing) elMissing.innerText = missingCount;

            // --- B. ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà "‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß" (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á) ---
            var html = "";
            if(reportedList.length === 0) {
                html = "<div style='color:rgba(255,255,255,0.5); text-align:center; font-size:0.8rem; padding-top:10px;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß</div>";
            } else {
                reportedList.forEach(item => {
                    html += `
                        <div style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:white; font-size:0.9rem;"><i class="fas fa-user-circle"></i> ${item.name}</span>
                            <span style="color:#eee; font-size:0.75rem;">${item.time}</span>
                        </div>
                    `;
                });
            }
            listContainer.innerHTML = html;

            // --- C. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown (‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å) ---
            updateDropdownOptions(reportedList);
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà populateAttendanceDropdown ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤)
        function updateDropdownOptions(reportedList) {
            var dropdown = document.getElementById('selAttendName');
            if (!dropdown || !contacts) return;

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
            var reportedNames = reportedList.map(r => r.name);

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏û‡∏≠‡∏î‡∏µ)
            var currentSelection = dropdown.value;

            dropdown.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á Dropdown ‡πÄ‡∏î‡∏¥‡∏°

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å
            var defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.innerText = "-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß --";
            dropdown.appendChild(defaultOpt);

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ
            var sortedContacts = contacts.slice().sort((a,b) => a.name.localeCompare(b.name));

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            sortedContacts.forEach(c => {
                // üî• ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                if (!reportedNames.includes(c.name)) {
                    // ‡∏ñ‡πâ‡∏≤ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤" -> ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á Dropdown
                    var opt = document.createElement('option');
                    opt.value = c.name;
                    opt.innerText = c.name;
                    dropdown.appendChild(opt);
                }
            });

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
            dropdown.value = currentSelection;
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
        function submitMyAttendance() {
            var name = document.getElementById('selAttendName').value;
            var pin = document.getElementById('attendPin').value;

            if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            if(!pin) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢");
            
            var btn = document.getElementById('btnAttendSubmit');
            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            google.script.run.withSuccessHandler(function(res){
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i>';

                if (res === "WrongPIN") {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! (‡πÉ‡∏ä‡πâ PIN ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)");
                    document.getElementById('attendPin').value = ''; 
                } else if (res === "WrongPass") {
                     // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏≠‡∏∑‡πà‡∏ô
                     alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                } else {
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ -> ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢
                    renderAttendance(res);
                    alert("‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    document.getElementById('attendPin').value = '';
                    document.getElementById('selAttendName').value = ""; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                }
            }).submitEmergencyAttendance(name, pin);
        }
        // ------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checklist + Attachments (Update V.4)
        // ------------------------------------------
        
       function renderChecklist(checklistData) {
            var container = document.getElementById('checklistContainer');
            if(!container) return;
            container.innerHTML = ""; 

            var globalIndex = 0; 
            EMERGENCY_STEPS.forEach(function(step) {
                // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô renderChecklist ‡∏Å‡πä‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏¥‡∏°) ...
                // ‡∏ß‡∏≤‡∏î Main Item
                var mainIdx = globalIndex++;
                var mainItem = checklistData ? checklistData[mainIdx] : null;
                container.appendChild(createCheckliItem(step.name, mainIdx, mainItem, false));

                // ‡∏ß‡∏≤‡∏î Sub Items
                if (step.subs && step.subs.length > 0) {
                    var subContainer = document.createElement('div');
                    subContainer.style.marginLeft = "22px"; 
                    subContainer.style.borderLeft = "2px solid rgba(255,255,255,0.15)"; 
                    subContainer.style.paddingLeft = "8px";
                    step.subs.forEach(function(subName) {
                        var subIdx = globalIndex++;
                        var subItem = checklistData ? checklistData[subIdx] : null;
                        subContainer.appendChild(createCheckliItem(subName, subIdx, subItem, true));
                    });
                    container.appendChild(subContainer);
                }
            });
        }

       // 2. ‚úÖ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ß‡∏≤‡∏î‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á Input)
        function renderCustomTasks(tasks) {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID ‡πÄ‡∏õ‡πá‡∏ô customTaskList (‡∏ß‡∏≤‡∏î‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            var container = document.getElementById('customTaskList'); 
            if(!container) return;
            container.innerHTML = "";

            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
            if (tasks.length > 0) {
                var header = document.createElement('div');
                header.innerHTML = '<hr style="border:0; border-top:1px dashed rgba(255,255,255,0.3); margin:10px 0;">' + 
                                   '<div style="color:#ffd700; font-size:0.9rem; margin-bottom:5px;">‚ö° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Ad-hoc)</div>';
                container.appendChild(header);
            }

            // ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            tasks.forEach(function(task, index) {
                var div = document.createElement('div');
                var bg = task.status ? "rgba(255,255,255,0.9)" : "rgba(255,215,0, 0.15)";
                var color = task.status ? "#1b5e20" : "#ffd700";
                var icon = task.status ? '<i class="fas fa-check-square" style="color:#2e7d32;"></i>' : '<i class="far fa-square"></i>';

                div.style.cssText = `display:flex; align-items:center; background:${bg}; padding:5px 10px; border-radius:4px; margin-bottom:4px; transition:0.2s; border:1px solid rgba(255,215,0,0.3);`;
                
                div.innerHTML = `
                    <div style="margin-right:8px; font-size:1.1rem; cursor:pointer;" onclick="toggleCustomTask(${index}, ${!task.status})">${icon}</div>
                    <div style="font-size:0.95rem; color:${color}; flex:1; cursor:pointer;" onclick="toggleCustomTask(${index}, ${!task.status})">${task.name}</div>
                    <i class="fas fa-trash-alt" onclick="removeCustomTask(${index})" style="color:#ef5350; cursor:pointer; font-size:0.8rem; margin-left:10px; opacity:0.7;" title="‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à"></i>
                `;
                container.appendChild(div);
            });
            
            // ‚ùå ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á Input ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥‡πÉ‡∏ô HTML ‡πÅ‡∏•‡πâ‡∏ß)
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
        function addNewTask() {
            var input = document.getElementById('newCustomTask');
            var val = input.value.trim();
            if(!val) return;
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Server
            var oldText = input.value;
            input.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°..."; 
            input.disabled = true;

            google.script.run.withSuccessHandler(function(updatedTasks){
                renderCustomTasks(updatedTasks);
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ + ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                input.value = ""; 
                input.disabled = false;
                input.focus();
            }).addCustomTask(val);
        }
        // --- Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ---

        function toggleCustomTask(index, newStatus) {
            google.script.run.withSuccessHandler(function(updatedTasks){
                renderCustomTasks(updatedTasks);
            }).updateCustomTask(index, newStatus);
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏≠‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Disabled ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
        function addNewTask() {
            var input = document.getElementById('newCustomTask');
            var val = input.value.trim();
            if(!val) return;
            
            // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ! (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠)
            input.value = ""; 
            input.focus(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°

            // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡∏™‡πà‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ)
            google.script.run.withSuccessHandler(function(updatedTasks){
                renderCustomTasks(updatedTasks);
            }).addCustomTask(val);
        }

        function removeCustomTask(index) {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            google.script.run.withSuccessHandler(function(updatedTasks){
                renderCustomTasks(updatedTasks);
            }).deleteCustomTask(index);
        }

        // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå
        function createCheckliItem(text, index, itemData, isSub) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Bool)
            var isChecked = false;
            var file = null;
            
            if (itemData && typeof itemData === 'object') {
                isChecked = itemData.status;
                file = itemData.file;
            } else {
                isChecked = !!itemData;
            }

            var div = document.createElement('div');
            var bg = isChecked ? "rgba(255,255,255,0.9)" : "rgba(255,255,255,0.1)";
            var color = isChecked ? "#1b5e20" : "#fff";
            var fontSize = isSub ? "0.85rem" : "0.95rem"; 
            var fontWeight = (isChecked || !isSub) ? "bold" : "normal";
            var icon = isChecked ? '<i class="fas fa-check-square" style="color:#2e7d32;"></i>' : '<i class="far fa-square"></i>';

            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
            var fileHtml = '';
            if (file) {
                fileHtml = `
                    <div style="display:flex; align-items:center; gap:5px; margin-left:8px;">
                        <a href="${file.url}" target="_blank" onclick="event.stopPropagation()" style="background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px; font-size:0.75rem; text-decoration:none; font-weight:bold;">
                            <i class="fas fa-paperclip"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                        </a>
                        <i class="fas fa-times" onclick="event.stopPropagation(); deleteEmgFile(${index})" style="color:#ef5350; cursor:pointer; font-size:0.8rem;" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå"></i>
                    </div>
                `;
            } else {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏à‡∏≤‡∏á‡πÜ)
                fileHtml = `
                    <i class="fas fa-paperclip" onclick="event.stopPropagation(); openEmgUpload(${index}, '${text}')" style="color:${isChecked?'#999':'rgba(255,255,255,0.5)'}; margin-left:8px; cursor:pointer; font-size:0.9rem;" title="‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô"></i>
                `;
            }

            div.style.cssText = `display:flex; align-items:center; justify-content:space-between; background:${bg}; padding:5px 10px; border-radius:4px; cursor:pointer; margin-bottom:4px; transition:0.2s;`;
            
            // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö = ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å (Toggle)
            div.onclick = function() { toggleChecklist(index, !isChecked); };

            div.innerHTML = `
                <div style="display:flex; align-items:center; flex:1;">
                    <div style="margin-right:8px; font-size:1.1rem;">${icon}</div>
                    <div style="font-size:${fontSize}; color:${color}; font-weight:${fontWeight};">${text}</div>
                </div>
                ${fileHtml}
            `;
            return div;
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ---
        function openEmgUpload(index, title) {
            document.getElementById('emgUploadIndex').value = index;
            document.getElementById('lblEmgUploadTopic').innerText = title;
            document.getElementById('emgFile').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤
            document.getElementById('modalEmgUpload').style.display = 'flex';
        }

        function submitEmgUpload() {
            var fileInput = document.getElementById('emgFile');
            if(fileInput.files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå");
            
            var file = fileInput.files[0];
            var index = document.getElementById('emgUploadIndex').value;
            var reader = new FileReader();
            
            var btn = document.getElementById('btnEmgUpload');
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î..."; btn.disabled = true;

            reader.onload = function(e) {
                var fileData = e.target.result.split(',')[1]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà Base64
                var payload = {
                    index: index,
                    fileData: fileData,
                    fileName: file.name,
                    mimeType: file.type
                };
                
                google.script.run.withSuccessHandler(function(updatedList) {
                    renderChecklist(updatedList);
                    document.getElementById('modalEmgUpload').style.display = 'none';
                    btn.innerText = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"; btn.disabled = false;
                }).uploadEmergencyEvidence(payload);
            };
            reader.readAsDataURL(file);
        }

        function deleteEmgFile(index) {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            google.script.run.withSuccessHandler(function(updatedList) {
                renderChecklist(updatedList);
            }).deleteEmergencyEvidence(index);
        }
        function toggleChecklist(index, newStatus) {
            google.script.run.withSuccessHandler(function(updatedList){
                renderChecklist(updatedList);
            }).updateChecklist("", index, newStatus);
        }
        // ------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Timeline (Update: ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ/‡∏•‡∏ö)
        // ------------------------------------------
        function renderLogs(logs) {
            var container = document.getElementById('logContainer');
            if(!container) return; 
            
            var html = "";
            if (!logs || logs.length === 0) {
                container.innerHTML = "<div style='color:rgba(255,255,255,0.5); text-align:center; padding-top:20px;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>";
                return;
            }

            logs.forEach(function(item, index) {
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Å‡∏±‡∏ô error
                var safeMsg = item.msg.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                html += `
                    <div style="margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; display:flex; justify-content:space-between; align-items:start;">
                        <div style="flex:1; text-align:left;">
                            <span style="background:#ffc107; color:#000; padding:1px 4px; border-radius:3px; font-size:0.75rem; font-weight:bold; margin-right:5px;">${item.time}</span>
                            <span style="color:#fff; font-size:0.9rem;">${item.msg}</span>
                        </div>
                        <div style="display:flex; gap:10px; margin-left:10px; opacity:0.8;">
                            <i class="fas fa-pen" onclick="editLog(${index}, '${safeMsg}')" style="color:#fff; cursor:pointer; font-size:0.8rem;" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></i>
                            <i class="fas fa-trash" onclick="deleteLog(${index})" style="color:#ffcdd2; cursor:pointer; font-size:0.8rem;" title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></i>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤)
        function editLog(index, oldMsg) {
            var pass = prompt("üîê (Admin) ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:");
            if (!pass) return;

            var newMsg = prompt("‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", oldMsg);
            if (!newMsg || newMsg === oldMsg) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡∏à‡∏ö

            google.script.run.withSuccessHandler(function(res){
                if(res === "WrongPass") alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
                else renderLogs(res);
            }).editCommanderLog(pass, index, newMsg);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)
        function deleteLog(index) {
            var pass = prompt("üîê (Admin) ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:");
            if (!pass) return;

            if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ?")) return;

            google.script.run.withSuccessHandler(function(res){
                if(res === "WrongPass") alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
                else renderLogs(res);
            }).deleteCommanderLog(pass, index);
        }

        function postLog() {
            var msg = prompt("üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Admin Only):");
            if (!msg) return;
            
            google.script.run.withSuccessHandler(function(updatedLogs){
                renderLogs(updatedLogs);
            }).addCommanderLog(msg);
        }

        // ------------------------------------------
        // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
        // ------------------------------------------
        function showEmergencyScreen(msg) {
            document.getElementById('emergencyMsg').innerText = msg;
            document.getElementById('emergencyOverlay').style.display = 'flex';
        }

        function activateEmergency() {
            var pass = prompt("üîê ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin (9999) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô:");
            if (!pass) return;
            
            var msg = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•):", "‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡πÄ‡∏ú‡∏ä‡∏¥‡∏ç‡πÄ‡∏´‡∏ï‡∏∏");
            if (!msg) return;

            google.script.run.withSuccessHandler(function(res){
                if(res === "Success") {
                    alert("üö® ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß! War Room ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
                    checkEmergencyStatus();
                } else {
                    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
                }
            }).setEmergencyState(pass, true, msg);
        }

        function deactivateEmergency() {
            var pass = prompt("üîê ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:");
            if (!pass) return;

            google.script.run.withSuccessHandler(function(res){
                if(res === "Success") {
                    alert("‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                    document.getElementById('emergencyOverlay').style.display = 'none';
                    loadAllData();
                } else {
                    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
                }
            }).setEmergencyState(pass, false, "");
        }

        // ‚úÖ ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(checkEmergencyStatus, 5000);
        // ==========================================
        // ‚ö° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏´‡∏ï‡∏∏ (Modal)
        // ==========================================

        // 1. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        function openEmerModal() {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
            document.getElementById('emerEventDetail').value = "";
            document.getElementById('modalEmergency').style.display = 'flex'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            document.getElementById('emerEventDetail').focus(); // ‡πÄ‡∏≠‡∏≤‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        }

        // 2. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
        function closeEmerModal() {
            document.getElementById('modalEmergency').style.display = 'none';
        }

        // 3. ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ War Room)
        function confirmEmerStart() {
            var plan = document.getElementById('emerPlanType').value;
            var level = document.getElementById('emerLevel').value;
            var detail = document.getElementById('emerEventDetail').value.trim();

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if(!detail) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // ‡∏ñ‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
            var pass = prompt("üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin (9999) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:");
            if(!pass) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î cancel ‡∏Å‡πá‡∏à‡∏ö

            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "[‡πÅ‡∏ú‡∏ô‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏£‡∏∞‡∏¢‡∏≠‡∏á] ‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 : ‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•"
            var fullMessage = "[" + plan + "] " + level + " : " + detail;

            // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            closeEmerModal();

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setEmergencyState ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏õ‡πä‡∏≠‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            google.script.run.withSuccessHandler(function(res){
                if(res == "WrongPass") {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö!");
                } else {
                    // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡πÑ‡∏Å‡πÄ‡∏î‡∏¥‡∏°
                    console.log("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            }).setEmergencyState(pass, true, fullMessage);
        }

    </script>
    <div id="modalEmergency" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:25px; border-radius:12px; width:95%; max-width:700px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        
        <div style="border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:20px;">
            <h3 style="margin:0; color:#c0392b;"><i class="fas fa-exclamation-triangle"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3>
            <p style="margin:5px 0 0 0; font-size:0.9rem; color:#666;">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</p>
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
            
            <div style="flex:2; min-width:200px;">
                <label style="font-weight:bold; font-size:0.9rem; color:#333;">1. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ú‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label>
                <select id="emerPlanType" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-top:5px; font-size:1rem; background:#f9f9f9; color:#333;">
                    <option value="‡πÅ‡∏ú‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏†‡∏±‡∏¢">‡πÅ‡∏ú‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏†‡∏±‡∏¢</option>
                    <option value="‡πÅ‡∏ú‡∏ô‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏£‡∏∞‡∏¢‡∏≠‡∏á">‡πÅ‡∏ú‡∏ô‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏£‡∏∞‡∏¢‡∏≠‡∏á</option>
                    <option value="‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢">‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏Ñ‡∏Ñ‡∏µ‡∏†‡∏±‡∏¢</option>
                    <option value="‡πÅ‡∏ú‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏†‡∏±‡∏¢‡∏´‡∏°‡∏π‡πà (RESCUE-C)">‡πÅ‡∏ú‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏†‡∏±‡∏¢‡∏´‡∏°‡∏π‡πà (RESCUE-C)</option>
                </select>
            </div>

            <div style="flex:1; min-width:120px;">
                <label style="font-weight:bold; font-size:0.9rem; color:#333;">2. ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
                <select id="emerLevel" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-top:5px; font-size:1rem; background:#f9f9f9; color:#333;">
                    <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö 1">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 </option>
                    <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö 2">‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 </option>
                    <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö 3">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 </option>
                    <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö 4">‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 </option>
                </select>
            </div>

        </div>

        <div style="margin-bottom:25px;">
            <label style="font-weight:bold; font-size:0.9rem; color:#333;">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
            <input type="text" id="emerEventDetail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏• ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 5, ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-top:5px; font-size:1rem; color:#333;">
        </div>

        <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="closeEmerModal()" style="padding:10px 20px; border:none; background:#ccc; color:white; border-radius:6px; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="confirmEmerStart()" style="padding:10px 25px; border:none; background:#c0392b; color:white; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1rem;">
                üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            </button>
        </div>

    </div>
</div>
</body>
</html>